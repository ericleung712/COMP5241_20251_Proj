<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Smart Classroom Platform</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="/static/js/i18n.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* General styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background: #f5f6fa;
            color: #222;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Top navigation bar */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #082f49;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            width: 300px;
            font-size: 14px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .header-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 80px;
            height: calc(100vh - 60px);
            background-color: #082f49;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 999;
        }

        .sidebar-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
        }
        
        .sidebar-icon svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }

        .sidebar-icon:hover,
        .sidebar-icon.active {
            background: #0b4b70;
            transform: scale(1.05);
        }

        /* Main content area */
        main {
            margin-left: 80px;
            margin-top: 60px;
            flex: 1;
            padding: 30px 40px;
            overflow-y: auto;
            background: #f5f6fa;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #082f49;
            margin-bottom: 10px;
        }

        .welcome-text {
            color: #0b4b70;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Welcome banner */
        .welcome-banner {
            background: linear-gradient(135deg, #0b4b70 0%, #083d5d 100%);
            color: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .welcome-banner h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .welcome-banner p {
            font-size: 16px;
            opacity: 0.9;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        /* Action cards */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .action-card h3 {
            color: #082f49;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .action-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .create-form {
            display: flex;
            gap: 10px;
        }

        .create-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .create-btn {
            background: #082f49;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .create-btn:hover {
            background: #0b4b70;
        }

        /* Content area */
        .content-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .section h3 {
            color: #082f49;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        header h1::before {
            content: "üë®‚Äçüè´";
            font-size: 22px;
        }

        header .nav-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lang-switch {
            background: #fff;
            color: #082f49;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn {
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            cursor: pointer;
        }


        /* Metrics card layout */
        .metrics {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            flex: 1;
            background: #083d5d;
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }

        .metric-card h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .metric-card p {
            font-size: 28px;
            font-weight: bold;
        }

        /* Section title */
        section h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #082f49;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Card block */
        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.05);
        }

        .card .loading {
            color: #999;
            text-align: center;
            padding: 10px 0;
        }

        button.primary {
            background-color: #083d5d;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        button.primary:hover {
            background-color: #0b4b70;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            main {
                padding: 20px;
            }

            .metrics {
                flex-direction: column;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        /* Course card styles */
        .course-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .course-title {
            font-size: 18px;
            font-weight: 600;
            color: #082f49;
            margin-bottom: 10px;
        }
        
        .course-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .activity-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .activity-type-card {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .activity-type-card:hover,
        .activity-type-card.selected {
            border-color: #4facfe;
            background: #e3f2fd;
        }
        
        .activity-type-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .ai-section h3 {
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Top navigation bar -->
    <header>
        <div class="platform-logo" style="display: flex; align-items: center; margin-left: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 260 90" style="height:40px;">
                <!-- Background hexagon outline (PolyU style) -->
                <polygon points="30,45 50,15 90,15 110,45 90,75 50,75" fill="none" stroke="#ff6b6b" stroke-width="3"/>

                <!-- Open book (education) -->
                <path d="M60 40 Q75 25 90 40 Q105 55 120 40 Q135 25 150 40" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" />

                <!-- Book spine -->
                <line x1="105" y1="40" x2="105" y2="70" stroke="#ffffff" stroke-width="3"/>

                <!-- Circuit nodes (technology connection lines) -->
                <circle cx="75" cy="28" r="3" fill="#4facfe"/>
                <circle cx="135" cy="28" r="3" fill="#4facfe"/>
                <line x1="75" y1="28" x2="135" y2="28" stroke="#4facfe" stroke-width="2" stroke-dasharray="4 3"/>

                <!-- Light bulb on book -->
                <circle cx="105" cy="18" r="4" fill="#ffd54f"/>

                <!-- Text section -->
                <text x="160" y="42" font-size="18" font-family="Inter, PingFang SC, sans-serif" font-weight="700" fill="#ffffff">PolyLearn</text>
                <text x="160" y="65" font-size="12" font-family="Inter, sans-serif" fill="#b0bec5">Smart Learning</text>
            </svg>
        </div>
        <div class="header-actions" style="margin-left: auto;">
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-icon active" onclick="showHome()" title="Home">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9.5L12 3l9 6.5v11a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/>
            </svg>
        </div>
        <div class="sidebar-icon" onclick="showCourses()" title="Courses">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 3h14a2 2 0 0 1 2 2v16l-7-3-7 3V5a2 2 0 0 1 2-2z"/>
            </svg>
        </div>
        <div class="sidebar-icon" onclick="showActivities()" title="Activities">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h5l2 3h9a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>
            </svg>
        </div>
        <div class="sidebar-icon" onclick="showGeneralAIAssistant()" title="AI Assistant">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="8" width="18" height="8" rx="3" ry="3"/>
                <circle cx="9" cy="12" r="1"/>
                <circle cx="15" cy="12" r="1"/>
                <path d="M12 3v3M12 18v3M5 12H2M22 12h-3M8 20l-1 2M16 20l1 2"/>
            </svg>
        </div>
        <div class="sidebar-icon" onclick="logout()" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
        </div>
    </nav>

    <!-- Main content area -->
    <main>
        <h1 class="page-title">Teacher Portal</h1>
        <p class="welcome-text">Welcome back, @user name</p>

        <!-- Welcome banner -->
        <div class="welcome-banner">
            <h2>Welcome to your Teacher Portal</h2>
            <p>Create and manage courses, design engaging activities, and track student progress. Empower your teaching with smart tools!</p>
        </div>

        <!-- Data metrics -->
        <div class="metrics">
            <div class="metric-card">
                <h3>Total Courses</h3>
                <p id="totalCourses">0</p>
            </div>
            <div class="metric-card">
                <h3>Total Activities</h3>
                <p id="totalActivities">0</p>
            </div>
            <div class="metric-card">
                <h3>Active Activities</h3>
                <p id="activeActivities">0</p>
            </div>
            <div class="metric-card">
                <h3>Completed Activities</h3>
                <p id="completedActivities">0</p>
            </div>
        </div>

        <!-- Action cards -->
        <div class="action-cards">
            <div class="action-card">
                <h3>Course Management</h3>
                <p>Create and manage your courses</p>
                <button class="create-btn" onclick="showCreateCourseModal()">Create Course</button>
            </div>
            
            <div class="action-card">
                <h3>Activity Management</h3>
                <p>Design engaging learning activities</p>
                <button class="create-btn" onclick="showCreateActivityModal()">Create Activity</button>
            </div>
            
            <div class="action-card">
                <h3>Student Overview</h3>
                <p>Monitor student progress and performance</p>
                <div class="create-form">
                    <input type="text" class="create-input" placeholder="Search students...">
                    <button class="create-btn" onclick="searchStudents()">Search</button>
                </div>
            </div>
            
            <div class="action-card">
                <h3>Import Students (Excel)</h3>
                <p>Import students from Excel file</p>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; border: 2px dashed #4facfe; margin-top: 10px;">
                    <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
                        <strong>Excel File Format Requirements:</strong><br>
                        ‚Ä¢ Required columns: student_id (Student ID), full_name (Name), email (Email)<br>
                        ‚Ä¢ Optional columns: department (Department), course_code (Course Code, for auto-enrollment)<br>
                        ‚Ä¢ Supported formats: .xlsx, .xls
                    </p>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="margin-bottom: 10px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <button class="create-btn" onclick="importStudentsFromExcel()" style="width: 100%;">
                        Upload and Import Students
                    </button>
                    <div id="excelImportResult" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- Content area -->
        <div class="content-sections">
            <!-- Course Management -->
            <div class="section">
                <h3>Course Management</h3>
                <div id="coursesList" class="loading">Loading...</div>
            </div>

            <!-- Activity Management -->
            <div class="section">
                <h3>Activity Management</h3>
                <div id="activitiesList" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Performance Box -->
        <div class="section" style="margin-top: 30px;">
            <h3>Performance Overview</h3>
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <canvas id="teacherQuizScoreChart" style="max-width: 100%; height: 400px;"></canvas>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="section" style="margin-top: 30px;">
            <h3>Recent Activities</h3>
            <div id="recentActivities" class="loading">Loading...</div>
        </div>
    </main>

    <footer>
        Smart Classroom Platform ¬© 2025
    </footer>
    
    <!-- Create course modal -->
    <div id="createCourseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createCourseModal')">&times;</span>
            <h2>Create New Course</h2>
            <form id="createCourseForm">
                <div class="form-group">
                    <label for="courseCode">Course Code:</label>
                    <input type="text" id="courseCode" placeholder="e.g., COMP5241" required>
                </div>
                <div class="form-group">
                    <label for="courseName">Course Name:</label>
                    <input type="text" id="courseName" placeholder="Enter course name" required>
                </div>
                <div class="form-group">
                    <label for="courseDescription">Course Description:</label>
                    <textarea id="courseDescription" placeholder="Enter course description"></textarea>
                </div>
                <div class="form-group">
                    <label for="semester">Semester:</label>
                    <select id="semester" required>
                        <!-- Semester options will be generated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="academicYear">Academic Year:</label>
                    <input type="text" id="academicYear" required>
                </div>
                <button type="submit" class="btn">Create Course</button>
            </form>
        </div>
    </div>
    
    <!-- Create activity modal -->
    <div id="createActivityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createActivityModal')">&times;</span>
            <h2>Create New Activity</h2>
            
            <div class="ai-section">
                <h3>ü§ñ AI Smart Generation</h3>
                <p>Let AI automatically generate learning activities based on your teaching content</p>
                <button class="btn btn-success" onclick="showAIGenerator()">Use AI Generation</button>
            </div>
            
            <form id="createActivityForm">
                <div class="form-group">
                    <label for="activityCourse">Select Course:</label>
                    <select id="activityCourse" required>
                        <option value="">Select Course</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Activity Type:</label>
                    <div class="activity-type-selector">
                        <div class="activity-type-card" data-type="poll" onclick="selectActivityType('poll')">
                            <div class="activity-type-icon">üìä</div>
                            <div>Poll</div>
                        </div>
                        <div class="activity-type-card" data-type="quiz" onclick="selectActivityType('quiz')">
                            <div class="activity-type-icon">‚ùì</div>
                            <div>Quiz</div>
                        </div>
                        <div class="activity-type-card" data-type="word_cloud" onclick="selectActivityType('word_cloud')">
                            <div class="activity-type-icon">‚òÅÔ∏è</div>
                            <div>Word Cloud</div>
                        </div>
                        <div class="activity-type-card" data-type="short_answer" onclick="selectActivityType('short_answer')">
                            <div class="activity-type-icon">‚úçÔ∏è</div>
                            <div>Short Answer</div>
                        </div>
                        <div class="activity-type-card" data-type="mini_game" onclick="selectActivityType('mini_game')">
                            <div class="activity-type-icon">üéÆ</div>
                            <div>Mini Game</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="activityTitle">Activity Title:</label>
                    <input type="text" id="activityTitle" placeholder="Enter activity title" required>
                </div>
                <div class="form-group">
                    <label for="activityDescription">Activity Description:</label>
                    <textarea id="activityDescription" placeholder="Enter activity description"></textarea>
                </div>
                <div class="form-group">
                    <label for="activityDuration">Duration (minutes):</label>
                    <input type="number" id="activityDuration" value="10" min="1" max="120">
                </div>
                
                <!-- Dynamic activity configuration area -->
                <div id="activityConfigSection" style="display: none;">
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e1e5e9;">
                    <h3 style="margin-bottom: 15px; color: #082f49;">Activity Configuration</h3>
                    
                    <!-- Poll activity configuration -->
                    <div id="pollConfig" class="activity-config" style="display: none;">
                        <div class="form-group">
                            <label for="pollQuestion">Poll Question:</label>
                            <input type="text" id="pollQuestion" placeholder="e.g., Which option do you think is most important?">
                        </div>
                        <div class="form-group">
                            <label>Options:</label>
                            <div id="pollOptions">
                                <div class="option-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" class="option-input" placeholder="Option 1">
                                    <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
                                </div>
                                <div class="option-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" class="option-input" placeholder="Option 2">
                                    <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addPollOption()" style="margin-top: 10px;">Add Option</button>
                        </div>
                    </div>
                    
                    <!-- Quiz activity configuration -->
                    <div id="quizConfig" class="activity-config" style="display: none;">
                        <div id="quizQuestions">
                            <!-- Quiz questions will be added here -->
                        </div>
                        <button type="button" class="btn btn-success" onclick="addQuizQuestion()" style="margin-top: 10px;">Add Question</button>
                    </div>
                    
                    <!-- Word cloud activity configuration -->
                    <div id="wordCloudConfig" class="activity-config" style="display: none;">
                        <div class="form-group">
                            <label for="wordCloudPrompt">Prompt:</label>
                            <input type="text" id="wordCloudPrompt" placeholder="e.g., Please enter keywords related to the topic">
                        </div>
                        <div class="form-group">
                            <label for="maxWords">Max Words:</label>
                            <input type="number" id="maxWords" value="10" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label for="minWordLength">Min Word Length:</label>
                            <input type="number" id="minWordLength" value="2" min="1" max="10">
                        </div>
                    </div>
                    
                    <!-- Short answer activity configuration -->
                    <div id="shortAnswerConfig" class="activity-config" style="display: none;">
                        <div class="form-group">
                            <label for="shortAnswerQuestion">Question:</label>
                            <textarea id="shortAnswerQuestion" placeholder="e.g., Please briefly explain..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="maxLength">Max Length (characters):</label>
                            <input type="number" id="maxLength" value="500" min="50" max="5000">
                        </div>
                        <div class="form-group">
                            <label for="sampleAnswer">Sample Answer (optional):</label>
                            <textarea id="sampleAnswer" placeholder="Sample answer..." rows="4"></textarea>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn">Create Activity</button>
            </form>
        </div>
    </div>
    
    <!-- AI generator modal -->
    <div id="aiGeneratorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('aiGeneratorModal')">&times;</span>
            <h2>ü§ñ AI Activity Generator</h2>
            
            <form id="aiGeneratorForm">
                <div class="form-group">
                    <label for="aiCourse">Select Course:</label>
                    <select id="aiCourse" required>
                        <option value="">Select Course</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="aiActivityType">Activity Type:</label>
                    <select id="aiActivityType" required>
                        <option value="">Select Activity Type</option>
                        <option value="poll">Poll</option>
                        <option value="quiz">Quiz</option>
                        <option value="word_cloud">Word Cloud</option>
                        <option value="short_answer">Short Answer</option>
                        <option value="mini_game">Mini Game</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="timeLimit">Time Limit (minutes, optional):</label>
                    <input type="number" id="timeLimit" min="1" placeholder="e.g., 10">
                </div>
                
                <div class="form-group">
                    <label for="courseContent">Course Content:</label>
                    <textarea id="courseContent" placeholder="Enter course content, AI will generate activities based on this" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Include Uploaded Documents (optional):</label>
                    <div id="documentSelection">
                        <select id="documentDropdown0" class="document-dropdown" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                            <option value="">Select documents to include their content in the prompt:</option>
                        </select>
                        <div id="additionalDropdowns"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="webResources">Web Resources (optional):</label>
                    <textarea id="webResources" placeholder="Enter relevant web resource links or content"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="additionalPrompt">Additional Requirements (optional):</label>
                    <textarea id="additionalPrompt" placeholder="Enter special requirements or preferences"></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">Generate Activity</button>
            </form>
            
            <div id="aiResult" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <!-- Course detail modal -->
    <div id="courseDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('courseDetailModal')">&times;</span>
            <h2>Course Details</h2>
            <div id="courseDetailContent" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- Activity detail modal -->
    <div id="activityDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('activityDetailModal')">&times;</span>
            <h2>Activity Details</h2>
            <div id="activityDetailContent" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- Activity results modal -->
    <div id="activityResultsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('activityResultsModal')">&times;</span>
            <h2>Activity Results</h2>
            <div id="activityResultsContent" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- Document management modal -->
    <div id="documentManagementModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('documentManagementModal')">&times;</span>
            <h2>Course Document Management</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showUploadDocumentForm()">Upload Document</button>
            </div>
            <div id="documentUploadForm" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Upload New Document</h3>
                <div class="form-group">
                    <label>Document Title:</label>
                    <input type="text" id="documentTitle" class="form-control" placeholder="Leave empty to use filename">
                </div>
                <div class="form-group">
                    <label>Document Description:</label>
                    <textarea id="documentDescription" class="form-control" rows="3" placeholder="Optional"></textarea>
                </div>
                <div class="form-group">
                    <label>Select File:</label>
                    <input type="file" id="documentFileInput" class="form-control" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.zip,.rar">
                    <small style="color: #666;">Supported formats: PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX, TXT, ZIP, RAR (max 50MB)</small>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="uploadDocument()">Upload</button>
                    <button class="btn btn-secondary" onclick="hideUploadDocumentForm()">Cancel</button>
                </div>
                <div id="documentUploadResult" style="margin-top: 10px;"></div>
            </div>
            <div id="documentsList" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- AI course assistant modal -->
    <div id="aiAssistantModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('aiAssistantModal')">&times;</span>
            <h2>ü§ñ AI Course Assistant</h2>
            <div id="aiAssistantCourseInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <p><strong>Course:</strong> <span id="aiAssistantCourseName">Loading...</span></p>
            </div>
            <div id="aiChatContainer" style="height: 400px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff;">
                <div id="aiChatMessages" style="min-height: 100%;">
                    <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                        <strong>AI Assistant:</strong> Hello! I'm an AI course assistant, and I can help you answer questions about the course. I can provide assistance based on course materials, activity content, and other information. Please feel free to ask!
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="aiQuestionInput" class="form-control" placeholder="Please enter your question..." style="flex: 1;" onkeypress="if(event.key === 'Enter') askAIQuestion()">
                <button class="btn btn-primary" onclick="askAIQuestion()">Send</button>
            </div>
            <div id="aiLoadingIndicator" style="display: none; margin-top: 10px; text-align: center; color: #666;">
                AI is thinking...
            </div>
        </div>
    </div>
    
    <!-- General AI assistant modal -->
    <div id="generalAIAssistantModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('generalAIAssistantModal')">&times;</span>
            <h2>ü§ñ General AI Assistant</h2>
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                <p style="margin: 0; color: #666; font-size: 14px;">
                    <strong>Tip:</strong> I can answer various questions. If you have questions about a specific course, I will guide you to use that course's AI assistant, which can provide more accurate answers based on course materials and activity information.
                </p>
            </div>
            <div id="generalAIChatContainer" style="height: 400px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff;">
                <div id="generalAIChatMessages" style="min-height: 100%;">
                    <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                        <strong>AI Assistant:</strong> Hello! I'm a general AI assistant, and I can help you answer various questions. If you have questions about a specific course, I will guide you to use that course's AI assistant. Please feel free to ask!
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="generalAIQuestionInput" class="form-control" placeholder="Please enter your question..." style="flex: 1;" onkeypress="if(event.key === 'Enter') askGeneralAIQuestion()">
                <button class="btn btn-primary" onclick="askGeneralAIQuestion()">Send</button>
            </div>
            <div id="generalAILoadingIndicator" style="display: none; margin-top: 10px; text-align: center; color: #666;">
                AI is thinking...
            </div>
        </div>
    </div>

    <!-- Forum modal -->
    <div id="forumModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('forumModal')">&times;</span>
            <h2>üí¨ Course Forum</h2>
            <div id="forumCourseInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <p><strong>Course:</strong> <span id="forumCourseName">Loading...</span></p>
            </div>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="document.getElementById('createPostModal').style.display='block'">Create New Post</button>
            </div>
            <div id="forumPostsList" style="max-height: 500px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; background: #fff;">
                <div class="loading">Loading forum posts...</div>
            </div>
        </div>
    </div>
    
    <!-- Create post modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('createPostModal')">&times;</span>
            <h2>Create New Post</h2>
            <div style="margin-bottom: 20px;">
                <label for="postTitle" style="display: block; margin-bottom: 5px; font-weight: bold;">Title:</label>
                <input type="text" id="postTitle" class="form-control" placeholder="Enter post title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label for="postContent" style="display: block; margin-bottom: 5px; font-weight: bold;">Content:</label>
                <textarea id="postContent" class="form-control" placeholder="Enter post content" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('createPostModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createForumPost()" style="margin-left: 10px;">Create Post</button>
            </div>
        </div>
    </div>

    <!-- Post details modal -->
    <div id="postDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('postDetailsModal')">&times;</span>
            <h2>Post Details</h2>
            <div id="postDetailsContent" style="max-height: 600px; overflow-y: auto;">
                <div class="loading">Loading post details...</div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let selectedActivityType = '';
        let aiGeneratedActivityData = null;
        let aiGeneratedCourseId = null;
        
        // Initialize on page load
        window.onload = async function() {
            await checkAuth();
            await loadDashboardData();
            await loadCourses();
            await loadActivities();
            updateSemesterOptions();
            updateAcademicYearPlaceholder();
            // Ensure form event listeners are bound
            console.log('Page loaded, form event listeners bound');
        };

        // Dynamically generate academicYear placeholder
        function updateAcademicYearPlaceholder() {
            const input = document.getElementById('academicYear');
            if (!input) return;
            const now = new Date();
            let year = now.getFullYear();
            let nextYear = (year + 1).toString().slice(-2);
            input.placeholder = `e.g.${year}-${nextYear}`;
        }

        // Dynamically generate semester options
        function updateSemesterOptions() {
            const semesterSelect = document.getElementById('semester');
            if (!semesterSelect) return;
            // Clear existing options
            semesterSelect.innerHTML = '<option value="">Select Semester</option>';
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 1;
            // Determine academic year based on month
            // Assumption: Fall (9-12), Spring (1-4), Summer (5-8)
            let semesters = [];
            if (month >= 9) {
                // Fall is this year, Spring is next year
                semesters.push({value: `Fall ${year}`, label: `Fall ${year}`});
                semesters.push({value: `Spring ${year+1}`, label: `Spring ${year+1}`});
                semesters.push({value: `Summer ${year+1}`, label: `Summer ${year+1}`});
            } else if (month >= 5) {
                // Summer is this year, Fall and Spring are this year/next year
                semesters.push({value: `Summer ${year}`, label: `Summer ${year}`});
                semesters.push({value: `Fall ${year}`, label: `Fall ${year}`});
                semesters.push({value: `Spring ${year+1}`, label: `Spring ${year+1}`});
            } else {
                // Spring is this year, Summer and Fall are this year
                semesters.push({value: `Spring ${year}`, label: `Spring ${year}`});
                semesters.push({value: `Summer ${year}`, label: `Summer ${year}`});
                semesters.push({value: `Fall ${year}`, label: `Fall ${year}`});
            }
            semesters.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.value;
                opt.textContent = s.label;
                semesterSelect.appendChild(opt);
            });
        }
        
        // Ensure event listeners are bound after DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded');
            });
        } else {
            console.log('DOM ready');
        }
        
        // Check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/profile');
                if (response.ok) {
                    currentUser = await response.json();
                    if (currentUser.role !== 'teacher') {
                        window.location.href = '/login';
                        return;
                    }
                    updateWelcomeMessage();
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Update welcome message
        function updateWelcomeMessage() {
            if (currentUser) {
                const welcomeText = document.querySelector('.welcome-text');
                welcomeText.textContent = `Welcome back, ${currentUser.full_name}`;
            }
        }
        
        // Sidebar navigation functions
        function showHome() {
            setActiveSidebar(0);
            // Refresh home page content
            location.reload();
        }
        
        function showCourses() {
            setActiveSidebar(1);
            // Scroll to courses section
            document.querySelector('.content-sections').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showActivities() {
            setActiveSidebar(2);
            // Scroll to activities section
            document.querySelector('.content-sections').scrollIntoView({ behavior: 'smooth' });
        }
        
        function logout() {
            setActiveSidebar(4);
            if (confirm('Are you sure you want to logout?')) {
                // Call logout API
                fetch('/api/auth/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(() => {
                        window.location.href = '/login';
                    });
            }
        }
        
        // Set active sidebar icon
        function setActiveSidebar(index) {
            document.querySelectorAll('.sidebar-icon').forEach((icon, i) => {
                icon.classList.toggle('active', i === index);
            });
        }
        
        // Search students function
        function searchStudents() {
            const input = document.querySelector('.create-input');
            const searchTerm = input.value.trim();
            if (searchTerm) {
                // Add search students logic here
                alert(`Searching for students: ${searchTerm}`);
                input.value = '';
            } else {
                alert('Please enter a search term');
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/analytics/dashboard');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalCourses').textContent = data.stats.total_courses;
                    document.getElementById('totalActivities').textContent = data.stats.total_activities;
                    document.getElementById('activeActivities').textContent = data.stats.active_activities;
                    document.getElementById('completedActivities').textContent = data.stats.completed_activities;
                    
                    // Display recent activities
                    displayRecentActivities(data.recent_activities);
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
            
            // Load teacher system overview for performance chart
            try {
                const overviewResponse = await fetch('/api/analytics/teacher/system-overview');
                if (overviewResponse.ok) {
                    const overviewData = await overviewResponse.json();
                    renderQuizScoreChart(overviewData);
                }
            } catch (error) {
                console.error('Failed to load system overview data:', error);
            }
        }
        
        // Display recent activities
        function displayRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            if (activities.length === 0) {
                container.innerHTML = '<p>No activities</p>';
                return;
            }
            
            const html = activities.map(activity => `
                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 10px;">
                    <h4>${activity.title}</h4>
                    <p>Course: ${activity.course_name || 'Unknown'}</p>
                    <p>Type: ${getActivityTypeName(activity.activity_type)}</p>
                    <p>Status: <span style="color: ${getStatusColor(activity.status)}">${getStatusName(activity.status)}</span></p>
                    <p>Created: ${new Date(activity.created_at).toLocaleString()}</p>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Render quiz score chart
        function renderQuizScoreChart(data) {
            const canvas = document.getElementById('teacherQuizScoreChart');
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const courseLabels = ['Courses']; // Single label for all bars
            const courseNames = data.course_breakdown.map(course => course.course_name);
            const courseCodes = data.course_breakdown.map(course => course.course_code);
            const avgScores = data.course_breakdown.map(course => course.avg_quiz_score);
            
            // Create separate datasets for each course to enable individual legend toggling
            const datasets = data.course_breakdown.map((course, index) => ({
                label: `${course.course_code} - ${course.course_name}`,
                data: [course.avg_quiz_score],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ][index % 6],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ][index % 6],
                borderWidth: 1
            }));
            
            canvas.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: courseLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Courses'
                            },
                            ticks: {
                                display: false // Hide x-axis ticks since we only have one label
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Average Quiz Score (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Average Quiz Scores by Course',
                            position: 'top'
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                boxWidth: 12,
                                boxHeight: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].dataset.label;
                                },
                                label: function(context) {
                                    return `Score: ${context.parsed.y}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load courses list
        async function loadCourses() {
            try {
                const response = await fetch('/api/courses/');
                if (response.ok) {
                    const courses = await response.json();
                    displayCourses(courses);
                    updateCourseSelectors(courses);
                }
            } catch (error) {
                document.getElementById('coursesList').innerHTML = '<div class="error">Failed to load courses</div>';
            }
        }
        
        // Display courses list
        function displayCourses(courses) {
            const container = document.getElementById('coursesList');
            if (courses.length === 0) {
                container.innerHTML = '<p>No courses</p>';
                return;
            }
            
            const html = courses.map(course => `
                <div class="course-card">
                    <div class="course-title">${course.course_name} (${course.course_code})</div>
                    <div class="course-meta">
                        Semester: ${course.semester} ${course.academic_year}<br>
                        Students: ${course.student_count || 0}<br>
                        Activities: ${course.activity_count || 0}<br>
                        Status: <span style="color: ${course.is_active ? '#28a745' : '#dc3545'}">${course.is_active ? 'Active' : 'Inactive'}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min((course.activity_count || 0) * 10, 100)}%"></div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="viewCourse(${course.id})">View Details</button>
                        <button class="btn btn-primary" onclick="showDocumentManagement(${course.id})">Manage Documents</button>
                        <button class="btn btn-success" onclick="showAIAssistant(${course.id})">ü§ñ AI Assistant</button>
                        <button class="btn btn-info" onclick="openForumModal(${course.id}, '${course.course_name} (${course.course_code})')" data-course-id="${course.id}">
                            üí¨ Forum${course.forum_unread ? ' ‚ùó' : ''}
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Update course selectors
        function updateCourseSelectors(courses) {
            const selectors = ['activityCourse', 'aiCourse'];
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                selector.innerHTML = '<option value="">Select Course</option>' + 
                    courses.map(course => `<option value="${course.id}">${course.course_name} (${course.course_code})</option>`).join('');
            });
        }
        
        // Load activities list
        async function loadActivities() {
            try {
                const response = await fetch('/api/activities/');
                if (response.ok) {
                    const activities = await response.json();
                    displayActivities(activities);
                }
            } catch (error) {
                document.getElementById('activitiesList').innerHTML = '<div class="error">Failed to load activities</div>';
            }
        }
        
        // Display activities list
        function displayActivities(activities) {
            const container = document.getElementById('activitiesList');
            if (activities.length === 0) {
                container.innerHTML = '<p>No activities</p>';
                return;
            }
            
            const html = activities.map(activity => `
                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 10px;">
                    <h4>${activity.title}</h4>
                    <p>Course: ${activity.course_name || 'Unknown'}</p>
                    <p>Type: ${getActivityTypeName(activity.activity_type)}</p>
                    <p>Status: <span style="color: ${getStatusColor(activity.status)}">${getStatusName(activity.status)}</span></p>
                    <p>Responses: ${activity.response_count}</p>
                    <div style="margin-top: 10px;">
                        ${activity.status === 'draft' ? `<button class="btn btn-success" onclick="startActivity(${activity.id})">Start Activity</button>` : ''}
                        ${activity.status === 'active' ? `<button class="btn btn-danger" onclick="stopActivity(${activity.id})">Stop Activity</button>` : ''}
                        <button class="btn btn-secondary" onclick="viewActivity(${activity.id})">View Details</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Show create course modal
        function showCreateCourseModal() {
            document.getElementById('createCourseModal').style.display = 'block';
        }
        
        // Show create activity modal
        function showCreateActivityModal() {
            document.getElementById('createActivityModal').style.display = 'block';
        }
        
        // Show AI generator
        function showAIGenerator() {
            document.getElementById('createActivityModal').style.display = 'none';
            document.getElementById('aiGeneratorModal').style.display = 'block';
            
            // Load documents when course is selected
            const courseSelect = document.getElementById('aiCourse');
            courseSelect.addEventListener('change', loadDocumentsForAI);
        }
        
        // Load documents for AI generator
        async function loadDocumentsForAI() {
            const courseId = document.getElementById('aiCourse').value;
            const documentDropdown = document.getElementById('documentDropdown0');
            const additionalDropdowns = document.getElementById('additionalDropdowns');
            
            if (!courseId) {
                documentDropdown.innerHTML = '<option value="">Select documents to include their content in the prompt:</option>';
                additionalDropdowns.innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/course/${courseId}`);
                if (response.ok) {
                    const documents = await response.json();
                    // Store documents globally for dropdown management
                    window.availableDocuments = documents;
                    window.selectedDocuments = [];
                    
                    if (documents.length === 0) {
                        documentDropdown.innerHTML = '<option value="">No documents available for this course</option>';
                        additionalDropdowns.innerHTML = '';
                    } else {
                        // Populate first dropdown
                        documentDropdown.innerHTML = '<option value="">Select documents to include their content in the prompt:</option>' +
                            documents.map(doc => `<option value="${doc.id}">${doc.title} (${doc.file_type.toUpperCase()}, ${(doc.file_size_mb || 0).toFixed(2)} MB)</option>`).join('');
                        
                        // Clear additional dropdowns
                        additionalDropdowns.innerHTML = '';
                        
                        // Add change event listener to first dropdown
                        documentDropdown.addEventListener('change', handleDocumentSelection);
                    }
                } else {
                    documentDropdown.innerHTML = '<option value="">Failed to load documents</option>';
                    additionalDropdowns.innerHTML = '';
                }
            } catch (error) {
                documentDropdown.innerHTML = '<option value="">Error loading documents</option>';
                additionalDropdowns.innerHTML = '';
            }
        }
        
        // Handle document selection in dropdowns
        function handleDocumentSelection(event) {
            const selectedValue = event.target.value;
            const previousValue = event.target.dataset.previousValue || '';
            
            if (selectedValue) {
                // Remove previous selection if different
                if (previousValue && previousValue !== selectedValue) {
                    const prevIndex = window.selectedDocuments.indexOf(parseInt(previousValue));
                    if (prevIndex > -1) {
                        window.selectedDocuments.splice(prevIndex, 1);
                    }
                }
                
                // Add to selected documents
                if (!window.selectedDocuments.includes(parseInt(selectedValue))) {
                    window.selectedDocuments.push(parseInt(selectedValue));
                }
                
                // Store current value as previous
                event.target.dataset.previousValue = selectedValue;
                
                // Create next dropdown if needed
                const dropdownIndex = parseInt(event.target.id.replace('documentDropdown', ''));
                const additionalDropdowns = document.getElementById('additionalDropdowns');
                const existingDropdowns = additionalDropdowns.querySelectorAll('.document-dropdown');
                
                if (dropdownIndex >= existingDropdowns.length) {
                    addNextDocumentDropdown();
                }
                
                // Update all dropdowns to exclude selected documents
                updateAllDropdowns();
            } else {
                // If deselected, remove from selected
                if (previousValue) {
                    const index = window.selectedDocuments.indexOf(parseInt(previousValue));
                    if (index > -1) {
                        window.selectedDocuments.splice(index, 1);
                    }
                }
                // Clear previous value
                event.target.dataset.previousValue = '';
                updateAllDropdowns();
            }
        }
        
        // Add next document dropdown
        function addNextDocumentDropdown() {
            const additionalDropdowns = document.getElementById('additionalDropdowns');
            const dropdownCount = additionalDropdowns.querySelectorAll('.document-dropdown').length + 1; // +1 for the first dropdown
            
            const dropdownContainer = document.createElement('div');
            dropdownContainer.style.cssText = 'display: flex; align-items: center; margin-bottom: 10px;';
            
            const select = document.createElement('select');
            select.id = `documentDropdown${dropdownCount}`;
            select.className = 'document-dropdown';
            select.style.cssText = 'flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;';
            select.innerHTML = '<option value="">Select another document (optional):</option>';
            
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger';
            removeButton.style.cssText = 'margin-left: 10px; padding: 8px 12px;';
            removeButton.textContent = 'Remove';
            removeButton.onclick = function() {
                removeDocumentDropdown(dropdownCount);
            };
            
            dropdownContainer.appendChild(select);
            dropdownContainer.appendChild(removeButton);
            additionalDropdowns.appendChild(dropdownContainer);
            
            // Add event listener
            select.addEventListener('change', handleDocumentSelection);
            
            // Update this dropdown
            updateDropdownOptions(select);
        }
        
        // Remove document dropdown
        function removeDocumentDropdown(index) {
            const dropdownContainer = document.getElementById(`documentDropdown${index}`).parentElement;
            const dropdown = document.getElementById(`documentDropdown${index}`);
            const selectedValue = dropdown.value;
            
            // Remove from selected documents
            if (selectedValue) {
                const docIndex = window.selectedDocuments.indexOf(parseInt(selectedValue));
                if (docIndex > -1) {
                    window.selectedDocuments.splice(docIndex, 1);
                }
            }
            
            // Remove the dropdown container
            dropdownContainer.remove();
            
            // Update all dropdowns
            updateAllDropdowns();
        }
        
        // Update all dropdown options
        function updateAllDropdowns() {
            const allDropdowns = document.querySelectorAll('.document-dropdown');
            allDropdowns.forEach(dropdown => {
                updateDropdownOptions(dropdown);
            });
        }
        
        // Update dropdown options for a specific dropdown
        function updateDropdownOptions(dropdown) {
            if (!window.availableDocuments) return;
            
            const currentValue = dropdown.value;
            const availableDocs = window.availableDocuments.filter(doc => 
                !window.selectedDocuments.includes(doc.id) || doc.id == currentValue
            );
            
            // Keep the placeholder/first option
            const firstOption = dropdown.querySelector('option:first-child');
            const placeholderText = firstOption ? firstOption.textContent : 'Select document:';
            
            dropdown.innerHTML = `<option value="">${placeholderText}</option>` +
                availableDocs.map(doc => `<option value="${doc.id}">${doc.title} (${doc.file_type.toUpperCase()}, ${(doc.file_size_mb || 0).toFixed(2)} MB)</option>`).join('');
            
            // Restore selected value if it was valid
            if (currentValue && availableDocs.some(doc => doc.id == currentValue)) {
                dropdown.value = currentValue;
            }
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // If it's the create activity modal, reset the form
            if (modalId === 'createActivityModal') {
                document.getElementById('createActivityForm').reset();
                selectedActivityType = '';
                document.querySelectorAll('.activity-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                // Hide configuration area
                document.getElementById('activityConfigSection').style.display = 'none';
                document.querySelectorAll('.activity-config').forEach(config => {
                    config.style.display = 'none';
                });
                // Reset option containers
                resetActivityConfigs();
            }
            
            // If it's the AI generator modal, reset the form and data
            if (modalId === 'aiGeneratorModal') {
                document.getElementById('aiGeneratorForm').reset();
                document.getElementById('aiResult').innerHTML = '';
                // Reset document dropdowns
                document.getElementById('documentDropdown0').innerHTML = '<option value="">Select documents to include their content in the prompt:</option>';
                document.getElementById('additionalDropdowns').innerHTML = '';
                aiGeneratedActivityData = null;
                aiGeneratedCourseId = null;
            }
            
            // If it's the post details modal, reset the viewing post ID
            if (modalId === 'postDetailsModal') {
                currentViewingPostId = null;
            }
        }
        
        // Reset activity configurations
        function resetActivityConfigs() {
            // Reset poll options
            const pollOptions = document.getElementById('pollOptions');
            if (pollOptions) {
                pollOptions.innerHTML = `
                    <div class="option-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="option-input" placeholder="Option 1">
                        <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
                    </div>
                    <div class="option-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="option-input" placeholder="Option 2">
                        <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
                    </div>
                `;
            }
            
            // Reset quiz questions
            const quizQuestions = document.getElementById('quizQuestions');
            if (quizQuestions) {
                quizQuestions.innerHTML = '';
                // Add one default question
                addQuizQuestion();
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Select activity type
        function selectActivityType(type) {
            selectedActivityType = type;
            document.querySelectorAll('.activity-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            // Show/hide configuration area
            const configSection = document.getElementById('activityConfigSection');
            const allConfigs = document.querySelectorAll('.activity-config');
            
            // Hide all configurations
            allConfigs.forEach(config => {
                config.style.display = 'none';
            });
            
            // Show corresponding configuration
            if (type === 'poll') {
                configSection.style.display = 'block';
                document.getElementById('pollConfig').style.display = 'block';
            } else if (type === 'quiz') {
                configSection.style.display = 'block';
                document.getElementById('quizConfig').style.display = 'block';
                // Initialize with one question if empty
                const quizQuestions = document.getElementById('quizQuestions');
                if (quizQuestions.children.length === 0) {
                    addQuizQuestion();
                }
            } else if (type === 'word_cloud') {
                configSection.style.display = 'block';
                document.getElementById('wordCloudConfig').style.display = 'block';
            } else if (type === 'short_answer') {
                configSection.style.display = 'block';
                document.getElementById('shortAnswerConfig').style.display = 'block';
            } else {
                configSection.style.display = 'none';
            }
        }
        
        // Add poll option
        function addPollOption() {
            const optionsContainer = document.getElementById('pollOptions');
            const optionCount = optionsContainer.children.length;
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            optionDiv.innerHTML = `
                <input type="text" class="option-input" placeholder="Option ${optionCount + 1}">
                <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
            `;
            optionsContainer.appendChild(optionDiv);
        }
        
        // Add quiz option
        // Add new quiz question
        function addQuizQuestion() {
            const questionsContainer = document.getElementById('quizQuestions');
            const questionIndex = questionsContainer.children.length;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question-item';
            questionDiv.dataset.questionIndex = questionIndex;
            questionDiv.style.cssText = 'padding: 20px; border: 2px solid #e1e5e9; border-radius: 12px; margin-bottom: 20px; background: #f8f9fa;';
            
            questionDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #082f49;">Question ${questionIndex + 1}</h4>
                    <button type="button" class="btn btn-danger" onclick="removeQuizQuestion(this)" style="padding: 5px 10px;">Remove Question</button>
                </div>
                <div class="form-group">
                    <label>Question Text:</label>
                    <input type="text" class="quiz-question-text" placeholder="e.g., Which of the following is correct?">
                </div>
                <div class="form-group">
                    <label>Options:</label>
                    <div class="quiz-options-container">
                        <div class="option-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <input type="text" class="option-input" placeholder="Option A">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="correctAnswer_${questionIndex}" value="0"> Correct Answer
                            </label>
                            <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
                        </div>
                        <div class="option-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <input type="text" class="option-input" placeholder="Option B">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="correctAnswer_${questionIndex}" value="1"> Correct Answer
                            </label>
                            <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addQuizOption(this)" style="margin-top: 10px;">Add Option</button>
                </div>
                <div class="form-group">
                    <label>Explanation:</label>
                    <textarea class="quiz-explanation" placeholder="Explain why this answer is correct" rows="3"></textarea>
                </div>
            `;
            
            questionsContainer.appendChild(questionDiv);
        }
        
        // Remove quiz question
        function removeQuizQuestion(button) {
            const questionItem = button.closest('.quiz-question-item');
            const container = questionItem.parentElement;
            
            if (container.children.length > 1) {
                questionItem.remove();
                updateQuizQuestionNumbers();
            } else {
                showMessage('At least one question must be kept', 'error');
            }
        }
        
        // Update quiz question numbers
        function updateQuizQuestionNumbers() {
            const questions = document.querySelectorAll('.quiz-question-item');
            questions.forEach((item, index) => {
                item.dataset.questionIndex = index;
                const header = item.querySelector('h4');
                if (header) {
                    header.textContent = `Question ${index + 1}`;
                }
                // Update radio button names
                const radios = item.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    radio.name = `correctAnswer_${index}`;
                });
            });
        }
        
        // Add option to a specific question
        function addQuizOption(button) {
            const questionItem = button.closest('.quiz-question-item');
            const optionsContainer = questionItem.querySelector('.quiz-options-container');
            const questionIndex = questionItem.dataset.questionIndex;
            const optionCount = optionsContainer.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            optionDiv.innerHTML = `
                <input type="text" class="option-input" placeholder="Option ${String.fromCharCode(65 + optionCount)}">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="correctAnswer_${questionIndex}" value="${optionCount}"> Correct Answer
                </label>
                <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="padding: 5px 10px;">Delete</button>
            `;
            optionsContainer.appendChild(optionDiv);
        }
        
        // Remove option
        function removeOption(button) {
            const optionItem = button.closest('.option-item');
            if (optionItem) {
                const container = optionItem.parentElement;
                if (container.children.length > 2) {
                    optionItem.remove();
                    updateQuizOptionIndices(container);
                } else {
                    showMessage('At least two options must be kept', 'error');
                }
            }
        }
        
        // Update quiz option indices
        function updateQuizOptionIndices(optionsContainer) {
            const questionItem = optionsContainer.closest('.quiz-question-item');
            const questionIndex = questionItem ? questionItem.dataset.questionIndex : 0;
            const options = optionsContainer.querySelectorAll('.option-item');
            
            options.forEach((item, index) => {
                const radio = item.querySelector('input[type="radio"]');
                if (radio) {
                    radio.value = index;
                    radio.name = `correctAnswer_${questionIndex}`;
                    const input = item.querySelector('.option-input');
                    if (input) {
                        input.placeholder = `Option ${String.fromCharCode(65 + index)}`;
                    }
                }
            });
        }
        
        // Create course form submission
        document.getElementById('createCourseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                course_code: document.getElementById('courseCode').value,
                course_name: document.getElementById('courseName').value,
                description: document.getElementById('courseDescription').value,
                semester: document.getElementById('semester').value,
                academic_year: document.getElementById('academicYear').value
            };
            
            try {
                const response = await fetch('/api/courses/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('Course created successfully!', 'success');
                    closeModal('createCourseModal');
                    document.getElementById('createCourseForm').reset();
                    loadCourses();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to create course', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        });
        
        // Create activity form submission
        document.getElementById('createActivityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Form submit event triggered');
            
            // Validate basic fields
            const title = document.getElementById('activityTitle').value.trim();
            const courseId = document.getElementById('activityCourse').value;
            
            if (!title) {
                showMessage('Please enter activity title', 'error');
                return;
            }
            
            if (!courseId) {
                showMessage('Please select a course', 'error');
                return;
            }
            
            if (!selectedActivityType) {
                showMessage('Please select activity type', 'error');
                return;
            }
            
            const data = {
                title: title,
                description: document.getElementById('activityDescription').value.trim(),
                activity_type: selectedActivityType,
                course_id: parseInt(courseId),
                duration_minutes: parseInt(document.getElementById('activityDuration').value) || 10,
                config: {}
            };
            
            // Collect configuration based on activity type
            if (selectedActivityType === 'poll') {
                const question = document.getElementById('pollQuestion').value.trim();
                const options = Array.from(document.querySelectorAll('#pollOptions .option-input')).map(input => input.value.trim()).filter(v => v);
                
                if (!question) {
                    showMessage('Please enter poll question', 'error');
                    return;
                }
                if (options.length < 2) {
                    showMessage('At least 2 options are required', 'error');
                    return;
                }
                
                data.config = {
                    question: question,
                    options: options
                };
            } else if (selectedActivityType === 'quiz') {
                const questionItems = document.querySelectorAll('.quiz-question-item');
                
                if (questionItems.length === 0) {
                    showMessage('Please add at least one question', 'error');
                    return;
                }
                
                const questions = [];
                let hasError = false;
                
                questionItems.forEach((questionItem, qIndex) => {
                    const questionText = questionItem.querySelector('.quiz-question-text').value.trim();
                    const options = Array.from(questionItem.querySelectorAll('.option-input')).map(input => input.value.trim()).filter(v => v);
                    const correctAnswerRadio = questionItem.querySelector('input[type="radio"]:checked');
                    const explanation = questionItem.querySelector('.quiz-explanation').value.trim();
                    
                    if (!questionText) {
                        showMessage(`Please enter text for question ${qIndex + 1}`, 'error');
                        hasError = true;
                        return;
                    }
                    if (options.length < 2) {
                        showMessage(`Question ${qIndex + 1} requires at least 2 options`, 'error');
                        hasError = true;
                        return;
                    }
                    if (!correctAnswerRadio) {
                        showMessage(`Please select correct answer for question ${qIndex + 1}`, 'error');
                        hasError = true;
                        return;
                    }
                    
                    questions.push({
                        question: questionText,
                        options: options,
                        correct_answer: parseInt(correctAnswerRadio.value),
                        explanation: explanation
                    });
                });
                
                if (hasError) return;
                
                data.config = { questions: questions };
            } else if (selectedActivityType === 'word_cloud') {
                const prompt = document.getElementById('wordCloudPrompt').value.trim();
                const maxWords = parseInt(document.getElementById('maxWords').value) || 10;
                const minWordLength = parseInt(document.getElementById('minWordLength').value) || 2;
                
                if (!prompt) {
                    showMessage('Please enter prompt', 'error');
                    return;
                }
                
                data.config = {
                    prompt: prompt,
                    max_words: maxWords,
                    min_word_length: minWordLength
                };
            } else if (selectedActivityType === 'short_answer') {
                const question = document.getElementById('shortAnswerQuestion').value.trim();
                const maxLength = parseInt(document.getElementById('maxLength').value) || 500;
                const sampleAnswer = document.getElementById('sampleAnswer').value.trim();
                
                if (!question) {
                    showMessage('Please enter question', 'error');
                    return;
                }
                
                data.config = {
                    question: question,
                    max_length: maxLength,
                    sample_answer: sampleAnswer
                };
            }
            
            console.log('Preparing to submit data:', data);
            
            try {
                showMessage('Creating activity...', 'success');
                const response = await fetch('/api/activities/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Activity created successfully:', result);
                    showMessage('Activity created successfully!', 'success');
                    document.getElementById('createActivityForm').reset();
                    selectedActivityType = '';
                    document.querySelectorAll('.activity-type-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    // Hide configuration area
                    document.getElementById('activityConfigSection').style.display = 'none';
                    document.querySelectorAll('.activity-config').forEach(config => {
                        config.style.display = 'none';
                    });
                    // Reset option containers
                    resetActivityConfigs();
                    closeModal('createActivityModal');
                    loadActivities();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    console.error('Failed to create activity:', error);
                    showMessage(error.error || 'Failed to create activity', 'error');
                }
            } catch (error) {
                console.error('Network error:', error);
                showMessage('Network error: ' + error.message, 'error');
            }
        });
        
        // AI generator form submission
        document.getElementById('aiGeneratorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const activityType = document.getElementById('aiActivityType').value;
            const courseId = parseInt(document.getElementById('aiCourse').value);
            
            // Get selected document IDs
            const selectedDocuments = window.selectedDocuments || [];
            
            const data = {
                activity_type: activityType,
                course_content: document.getElementById('courseContent').value,
                web_resources: document.getElementById('webResources').value,
                additional_prompt: document.getElementById('additionalPrompt').value,
                course_id: courseId,
                document_ids: selectedDocuments,
                time_limit: parseInt(document.getElementById('timeLimit').value) || null
            };
            
            // Store course ID and activity type for later use
            aiGeneratedCourseId = courseId;
            
            const resultDiv = document.getElementById('aiResult');
            resultDiv.innerHTML = '<div class="loading">AI is generating activity...</div>';
            
            try {
                const response = await fetch('/api/activities/ai/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayAIGeneratedActivity(result.generated_activity, activityType);
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<div class="error">${error.error || 'AI generation failed'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">Network error</div>';
            }
        });
        
        // Display AI generated activity
        function displayAIGeneratedActivity(activity, activityType) {
            console.log('Displaying AI activity:', activity, 'Type:', activityType);
            
            // Try to parse if description contains JSON
            let parsedActivity = activity;
            if (typeof activity.description === 'string' && activity.description.trim().startsWith('```json')) {
                try {
                    // Extract JSON from markdown code block
                    const jsonMatch = activity.description.match(/```json\s*(\{[\s\S]*?\})\s*```/);
                    if (jsonMatch) {
                        parsedActivity = JSON.parse(jsonMatch[1]);
                        console.log('Parsed from markdown:', parsedActivity);
                    }
                } catch (e) {
                    console.error('Failed to parse JSON from markdown:', e);
                }
            } else if (typeof activity.description === 'string' && activity.description.includes('{') && activity.description.includes('}')) {
                try {
                    // Try to extract JSON from plain text
                    const jsonMatch = activity.description.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsedActivity = JSON.parse(jsonMatch[0]);
                        console.log('Parsed from plain text:', parsedActivity);
                    }
                } catch (e) {
                    console.error('Failed to parse JSON from text:', e);
                }
            }
            
            // Store the parsed activity data
            aiGeneratedActivityData = { activity: parsedActivity, activityType: activityType };
            
            const resultDiv = document.getElementById('aiResult');
            
            // Build display content based on activity type
            let detailsHtml = '';
            
            // Handle quiz and short_answer with questions array
            if (parsedActivity.questions && Array.isArray(parsedActivity.questions)) {
                detailsHtml += `<div style="margin-top: 15px;">`;
                parsedActivity.questions.forEach((q, qIdx) => {
                    detailsHtml += `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
                    detailsHtml += `<p><strong>Question ${qIdx + 1}:</strong> ${q.question || ''}</p>`;
                    
                    if (q.options && Array.isArray(q.options)) {
                        detailsHtml += `<p><strong>Options:</strong></p><ul style="margin-left: 20px;">`;
                        q.options.forEach((opt, optIdx) => {
                            const isCorrect = q.correct_answer === optIdx || q.correct_answer === opt;
                            detailsHtml += `<li>${opt}${isCorrect ? ' <span style="color: green;">‚úì</span>' : ''}</li>`;
                        });
                        detailsHtml += `</ul>`;
                    }
                    
                    if (q.explanation) {
                        detailsHtml += `<p style="margin-top: 10px;"><strong>Explanation:</strong> ${q.explanation}</p>`;
                    }
                    
                    if (q.sample_answer) {
                        detailsHtml += `<p style="margin-top: 10px;"><strong>Sample Answer:</strong> ${q.sample_answer}</p>`;
                    }
                    
                    if (q.max_length) {
                        detailsHtml += `<p style="margin-top: 10px;"><strong>Max Length:</strong> ${q.max_length} characters</p>`;
                    }
                    
                    detailsHtml += `</div>`;
                });
                detailsHtml += `</div>`;
                
                if (parsedActivity.time_limit) {
                    detailsHtml += `<p><strong>Time Limit:</strong> ${Math.floor(parsedActivity.time_limit / 60)} minutes</p>`;
                }
            } else {
                // Handle single question format (poll, etc.)
                if (parsedActivity.question) {
                    detailsHtml += `<p><strong>Question:</strong> ${parsedActivity.question}</p>`;
                }
                
                if (parsedActivity.options && Array.isArray(parsedActivity.options)) {
                    detailsHtml += `<p><strong>Options:</strong></p><ul>`;
                    parsedActivity.options.forEach((opt, idx) => {
                        const isCorrect = parsedActivity.correct_answer === idx || parsedActivity.correct_answer === opt;
                        detailsHtml += `<li>${opt}${isCorrect ? ' ‚úì' : ''}</li>`;
                    });
                    detailsHtml += `</ul>`;
                } else if (parsedActivity.options) {
                    // Handle non-array options
                    detailsHtml += `<p><strong>Options:</strong> ${JSON.stringify(parsedActivity.options)}</p>`;
                }
                
                if (parsedActivity.explanation) {
                    detailsHtml += `<p><strong>Explanation:</strong> ${parsedActivity.explanation}</p>`;
                }
            }
            
            if (parsedActivity.prompt) {
                detailsHtml += `<p><strong>Prompt:</strong> ${parsedActivity.prompt}</p>`;
            }
            
            if (parsedActivity.max_words) {
                detailsHtml += `<p><strong>Max Words:</strong> ${parsedActivity.max_words}</p>`;
            }
            
            if (parsedActivity.max_length) {
                detailsHtml += `<p><strong>Max Length:</strong> ${parsedActivity.max_length} characters</p>`;
            }
            
            if (parsedActivity.sample_answer) {
                detailsHtml += `<p><strong>Sample Answer:</strong> ${parsedActivity.sample_answer}</p>`;
            }
            
            // Show raw content if no structured data found
            if (!detailsHtml && parsedActivity.description && parsedActivity.description !== activity.description) {
                detailsHtml += `<div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    <p><strong>Raw Response:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word;">${activity.description}</pre>
                </div>`;
            }
            
            resultDiv.innerHTML = `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>ü§ñ AI Generated Activity</h3>
                    <h4>${parsedActivity.title || activity.title || 'Untitled Activity'}</h4>
                    <p><strong>Description:</strong> ${parsedActivity.description && !parsedActivity.description.includes('{') ? parsedActivity.description : (activity.title ? 'AI generated activity' : 'No description')}</p>
                    ${detailsHtml}
                </div>
                <button class="btn btn-success" onclick="useAIGeneratedActivity()">Use This Activity</button>
                <button class="btn btn-secondary" onclick="regenerateActivity()">Regenerate</button>
            `;
        }
        
        // Use AI generated activity
        async function useAIGeneratedActivity() {
            if (!aiGeneratedActivityData || !aiGeneratedCourseId) {
                showMessage('No AI generated activity data found', 'error');
                return;
            }
            
            const { activity, activityType } = aiGeneratedActivityData;
            
            // Build the activity configuration based on type
            let config = {};
            
            if (activityType === 'poll') {
                config = {
                    question: activity.question || '',
                    options: activity.options || []
                };
            } else if (activityType === 'quiz') {
                // Handle quiz with questions array (multiple questions format)
                if (activity.questions && Array.isArray(activity.questions) && activity.questions.length > 0) {
                    const questions = activity.questions.map(q => {
                        // Ensure correct_answer is a number index
                        let correctAnswerIndex = q.correct_answer;
                        if (typeof correctAnswerIndex === 'string') {
                            // Try to find the index if it's a string matching an option
                            const foundIndex = q.options ? q.options.findIndex(opt => opt === correctAnswerIndex) : -1;
                            correctAnswerIndex = foundIndex >= 0 ? foundIndex : 0;
                        } else if (typeof correctAnswerIndex !== 'number') {
                            correctAnswerIndex = 0;
                        }
                        
                        return {
                            question: q.question || '',
                            options: q.options || [],
                            correct_answer: correctAnswerIndex,
                            explanation: q.explanation || ''
                        };
                    });
                    
                    config = { questions: questions };
                } else {
                    // Fallback to single question format (backward compatibility)
                    let correctAnswerIndex = activity.correct_answer;
                    if (typeof correctAnswerIndex === 'string') {
                        const foundIndex = activity.options ? activity.options.findIndex(opt => opt === correctAnswerIndex) : -1;
                        correctAnswerIndex = foundIndex >= 0 ? foundIndex : 0;
                    } else if (typeof correctAnswerIndex !== 'number') {
                        correctAnswerIndex = 0;
                    }
                    
                    config = {
                        questions: [{
                            question: activity.question || '',
                            options: activity.options || [],
                            correct_answer: correctAnswerIndex,
                            explanation: activity.explanation || ''
                        }]
                    };
                }
            } else if (activityType === 'word_cloud') {
                config = {
                    prompt: activity.prompt || '',
                    max_words: activity.max_words || 10,
                    min_word_length: activity.min_word_length || 2
                };
            } else if (activityType === 'short_answer') {
                // Handle short_answer with questions array
                if (activity.questions && Array.isArray(activity.questions) && activity.questions.length > 0) {
                    const firstQuestion = activity.questions[0];
                    config = {
                        question: firstQuestion.question || '',
                        max_length: firstQuestion.max_length || 500,
                        sample_answer: firstQuestion.sample_answer || ''
                    };
                } else {
                    // Fallback to single question format
                    config = {
                        question: activity.question || activity.prompt || '',
                        max_length: activity.max_length || 500,
                        sample_answer: activity.sample_answer || ''
                    };
                }
            }
            
            // Prepare the data for activity creation
            const data = {
                title: activity.title || 'AI Generated Activity',
                description: activity.description || '',
                activity_type: activityType,
                course_id: aiGeneratedCourseId,
                duration_minutes: activity.time_limit ? Math.floor(activity.time_limit / 60) : 10,
                config: config,
                is_ai_generated: true
            };
            
            console.log('Creating activity with data:', data);
            
            try {
                const response = await fetch('/api/activities/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage('Activity created successfully from AI suggestion!', 'success');
                    closeModal('aiGeneratorModal');
                    // Reset AI data
                    aiGeneratedActivityData = null;
                    aiGeneratedCourseId = null;
                    // Reset the AI generator form
                    document.getElementById('aiGeneratorForm').reset();
                    document.getElementById('aiResult').innerHTML = '';
                    // Reset document dropdowns
                    document.getElementById('documentDropdown0').innerHTML = '<option value="">Select documents to include their content in the prompt:</option>';
                    document.getElementById('additionalDropdowns').innerHTML = '';
                    // Reload activities list
                    loadActivities();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    console.error('Failed to create activity:', error);
                    showMessage(error.error || 'Failed to create activity', 'error');
                }
            } catch (error) {
                console.error('Network error:', error);
                showMessage('Network error: ' + error.message, 'error');
            }
        }
        
        // Regenerate activity
        function regenerateActivity() {
            document.getElementById('aiGeneratorForm').dispatchEvent(new Event('submit'));
        }
        
        // Start activity
        async function startActivity(activityId) {
            try {
                const response = await fetch(`/api/activities/${activityId}/start`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showMessage('Activity started!', 'success');
                    loadActivities();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to start activity', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Stop activity
        async function stopActivity(activityId) {
            try {
                const response = await fetch(`/api/activities/${activityId}/stop`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showMessage('Activity stopped!', 'success');
                    loadActivities();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to stop activity', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '80px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '10000';
            messageDiv.style.minWidth = '300px';
            messageDiv.style.maxWidth = '500px';
            messageDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Utility functions
        function getActivityTypeName(type) {
            const types = {
                'poll': 'Poll',
                'quiz': 'Quiz',
                'word_cloud': 'Word Cloud',
                'short_answer': 'Short Answer',
                'mini_game': 'Mini Game'
            };
            return types[type] || type;
        }
        
        function getStatusName(status) {
            const statuses = {
                'draft': 'Draft',
                'active': 'Active',
                'completed': 'Completed',
                'archived': 'Archived'
            };
            return statuses[status] || status;
        }
        
        function getStatusColor(status) {
            const colors = {
                'draft': '#6c757d',
                'active': '#28a745',
                'completed': '#007bff',
                'archived': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }
        
        // View course details
        async function viewCourse(courseId) {
            try {
                const response = await fetch(`/api/courses/${courseId}`);
                if (response.ok) {
                    const course = await response.json();
                    displayCourseDetail(course);
                    document.getElementById('courseDetailModal').style.display = 'block';
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to load course details', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Display course details
        function displayCourseDetail(course) {
            const container = document.getElementById('courseDetailContent');
            const html = `
                <div class="form-group">
                    <label>Course Code:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.course_code}</p>
                </div>
                <div class="form-group">
                    <label>Course Name:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.course_name}</p>
                </div>
                <div class="form-group">
                    <label>Course Description:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px; min-height: 60px;">${course.description || 'No description'}</p>
                </div>
                <div class="form-group">
                    <label>Teacher:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.teacher_name || 'Unknown'}</p>
                </div>
                <div class="form-group">
                    <label>Semester:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.semester}</p>
                </div>
                <div class="form-group">
                    <label>Academic Year:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.academic_year}</p>
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <span style="color: ${course.is_active ? 'green' : 'red'}">
                            ${course.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </p>
                </div>
                <div class="form-group">
                    <label>Student Count:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.student_count || 0}</p>
                </div>
                <div class="form-group">
                    <label>Activity Count:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${course.activity_count || 0}</p>
                </div>
                <div class="form-group">
                    <label>Created At:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        ${course.created_at ? new Date(course.created_at).toLocaleString() : 'Unknown'}
                    </p>
                </div>
                <div class="form-group">
                    <label>Updated At:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        ${course.updated_at ? new Date(course.updated_at).toLocaleString() : 'Unknown'}
                    </p>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e1e5e9;">
                <div class="form-group">
                    <label>Course Documents:</label>
                    <button class="btn btn-primary" onclick="showDocumentManagement(${course.id})" style="margin-top: 10px;">
                        Manage Documents
                    </button>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e1e5e9;">
                <div class="form-group">
                    <label>AI Course Assistant:</label>
                    <button class="btn btn-success" onclick="showAIAssistant(${course.id})" style="margin-top: 10px;">
                        ü§ñ Ask AI Assistant
                    </button>
                </div>
            `;
            container.innerHTML = html;
        }
        
        // Import students from Excel
        async function importStudentsFromExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const resultDiv = document.getElementById('excelImportResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="error" style="padding: 10px; margin-top: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">Please select an Excel file</div>';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file type
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                resultDiv.innerHTML = '<div class="error" style="padding: 10px; margin-top: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">Only Excel files (.xlsx, .xls) are supported</div>';
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading state
            resultDiv.innerHTML = '<div style="padding: 10px; margin-top: 10px; color: #0c5460; background: #d1ecf1; border-radius: 5px;">Uploading and processing Excel file...</div>';
            
            try {
                const response = await fetch('/api/courses/import-students-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let resultHtml = `<div style="padding: 15px; margin-top: 10px; border-radius: 5px; background: #d4edda; color: #155724;">
                        <h4 style="margin-bottom: 10px;">Import Complete!</h4>
                        <p><strong>New Students:</strong> ${result.imported_count}</p>
                        <p><strong>Updated Students:</strong> ${result.updated_count}</p>
                        <p><strong>Course Enrollments:</strong> ${result.enrolled_count}</p>
                        <p><strong>Skipped:</strong> ${result.skipped_count}</p>
                        <p><strong>Total Rows:</strong> ${result.total_rows}</p>
                    </div>`;
                    
                    if (result.errors && result.errors.length > 0) {
                        resultHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; max-height: 200px; overflow-y: auto; color: #856404;">
                            <strong>Errors (first 20):</strong>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                ${result.errors.map(err => `<li style="font-size: 12px;">${err}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    resultDiv.innerHTML = resultHtml;
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Refresh course list
                    loadCourses();
                    loadDashboardData();
                } else {
                    let errorMsg = result.error || 'Import failed';
                    if (result.required_columns) {
                        errorMsg += `<br>Required columns: ${result.required_columns.join(', ')}`;
                        if (result.found_columns) {
                            errorMsg += `<br>Found columns: ${result.found_columns.join(', ')}`;
                        }
                    }
                    resultDiv.innerHTML = `<div class="error" style="padding: 10px; margin-top: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">${errorMsg}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error" style="padding: 10px; margin-top: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">Network error: ${error.message}</div>`;
            }
        }
        
        // View activity details
        async function viewActivity(activityId) {
            try {
                const response = await fetch(`/api/activities/${activityId}`);
                if (response.ok) {
                    const activity = await response.json();
                    displayActivityDetail(activity);
                    document.getElementById('activityDetailModal').style.display = 'block';
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to load activity details', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Display activity details
        function displayActivityDetail(activity) {
            const container = document.getElementById('activityDetailContent');
            const config = activity.config || {};
            let configHtml = '';
            
            // Display different configuration information based on activity type
            if (activity.activity_type === 'poll') {
                if (config.question) {
                    configHtml += `<div class="form-group"><label>Question:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.question}</p></div>`;
                }
                if (config.options && Array.isArray(config.options)) {
                    configHtml += `<div class="form-group"><label>Options:</label><ul style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.options.map(opt => `<li>${opt}</li>`).join('')}</ul></div>`;
                }
            } else if (activity.activity_type === 'quiz') {
                if (config.questions && Array.isArray(config.questions)) {
                    // Multiple questions format
                    config.questions.forEach((q, index) => {
                        configHtml += `<div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">`;
                        configHtml += `<h4 style="color: #082f49; margin-bottom: 10px;">Question ${index + 1}</h4>`;
                        configHtml += `<div class="form-group"><label>Question Text:</label><p style="padding: 10px; background: white; border-radius: 5px;">${q.question}</p></div>`;
                        if (q.options && Array.isArray(q.options)) {
                            configHtml += `<div class="form-group"><label>Options:</label><ul style="padding: 10px; background: white; border-radius: 5px;">${q.options.map((opt, optIndex) => {
                                const isCorrect = q.correct_answer === optIndex;
                                return `<li style="color: ${isCorrect ? '#28a745' : 'inherit'}; font-weight: ${isCorrect ? 'bold' : 'normal'};">${opt} ${isCorrect ? '‚úì' : ''}</li>`;
                            }).join('')}</ul></div>`;
                        }
                        if (q.correct_answer !== undefined) {
                            configHtml += `<div class="form-group"><label>Correct Answer:</label><p style="padding: 10px; background: white; border-radius: 5px; color: #28a745; font-weight: bold;">Option ${String.fromCharCode(65 + q.correct_answer)}</p></div>`;
                        }
                        if (q.explanation) {
                            configHtml += `<div class="form-group"><label>Explanation:</label><p style="padding: 10px; background: white; border-radius: 5px;">${q.explanation}</p></div>`;
                        }
                        configHtml += `</div>`;
                    });
                } else {
                    // Old single question format (backward compatibility)
                    if (config.question) {
                        configHtml += `<div class="form-group"><label>Question:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.question}</p></div>`;
                    }
                    if (config.options && Array.isArray(config.options)) {
                        configHtml += `<div class="form-group"><label>Options:</label><ul style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.options.map(opt => `<li>${opt}</li>`).join('')}</ul></div>`;
                    }
                    if (config.correct_answer !== undefined) {
                        configHtml += `<div class="form-group"><label>Correct Answer:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.correct_answer}</p></div>`;
                    }
                    if (config.explanation) {
                        configHtml += `<div class="form-group"><label>Explanation:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.explanation}</p></div>`;
                    }
                }
            } else if (activity.activity_type === 'word_cloud') {
                if (config.prompt) {
                    configHtml += `<div class="form-group"><label>Prompt:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.prompt}</p></div>`;
                }
            } else if (activity.activity_type === 'short_answer') {
                if (config.question) {
                    configHtml += `<div class="form-group"><label>Question:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.question}</p></div>`;
                }
                if (config.max_length) {
                    configHtml += `<div class="form-group"><label>Max Length:</label><p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${config.max_length} characters</p></div>`;
                }
            }
            
            const html = `
                <div class="form-group">
                    <label>Activity Title:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${activity.title}</p>
                </div>
                <div class="form-group">
                    <label>Activity Description:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px; min-height: 60px;">${activity.description || 'No description'}</p>
                </div>
                <div class="form-group">
                    <label>Activity Type:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${getActivityTypeName(activity.activity_type)}</p>
                </div>
                <div class="form-group">
                    <label>Course:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${activity.course_name || 'Unknown'}</p>
                </div>
                <div class="form-group">
                    <label>Creator:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${activity.creator_name || 'Unknown'}</p>
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <span style="color: ${getStatusColor(activity.status)}">
                            ${getStatusName(activity.status)}
                        </span>
                    </p>
                </div>
                <div class="form-group">
                    <label>Duration:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${activity.duration_minutes || 10} minutes</p>
                </div>
                <div class="form-group">
                    <label>Response Count:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">${activity.response_count || 0}</p>
                </div>
                ${activity.start_time ? `
                <div class="form-group">
                    <label>Start Time:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        ${new Date(activity.start_time).toLocaleString()}
                    </p>
                </div>
                ` : ''}
                ${activity.end_time ? `
                <div class="form-group">
                    <label>End Time:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        ${new Date(activity.end_time).toLocaleString()}
                    </p>
                </div>
                ` : ''}
                <div class="form-group">
                    <label>Created At:</label>
                    <p style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        ${activity.created_at ? new Date(activity.created_at).toLocaleString() : 'Unknown'}
                    </p>
                </div>
                ${activity.is_ai_generated ? `
                <div class="form-group">
                    <label>AI Generated:</label>
                    <p style="padding: 10px; background: #e3f2fd; border-radius: 5px;">Yes</p>
                </div>
                ` : ''}
                ${configHtml}
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e1e5e9;">
                <div class="form-group">
                    <button class="btn btn-success" onclick="viewActivityResults(${activity.id})" style="width: 100%;">
                        View Activity Results (${activity.response_count || 0} responses)
                    </button>
                </div>
            `;
            container.innerHTML = html;
        }
        
        // View activity results
        async function viewActivityResults(activityId) {
            try {
                const response = await fetch(`/api/responses/activity/${activityId}`);
                if (response.ok) {
                    const responses = await response.json();
                    displayActivityResults(activityId, responses);
                    document.getElementById('activityResultsModal').style.display = 'block';
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to load results', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Display activity results
        function displayActivityResults(activityId, responses) {
            const container = document.getElementById('activityResultsContent');
            
            if (responses.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No responses</p>';
                return;
            }
            
            // Get activity information to display configuration
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    const config = activity.config || {};
                    let html = `<h3 style="margin-bottom: 20px;">Activity Results (${responses.length} responses)</h3>`;
                    
                    // If it's a poll activity, display visualization chart
                    if (activity.activity_type === 'poll') {
                        html += generatePollVisualization(responses, config);
                    }
                    
                    // Display detailed response list
                    html += `<hr style="margin: 30px 0; border: none; border-top: 1px solid #e1e5e9;">
                    <h4 style="margin-bottom: 15px;">Detailed Response List</h4>`;
                    
                    responses.forEach((resp, index) => {
                        const responseData = resp.response_data || {};
                        html += `
                            <div style="padding: 20px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 15px; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: #082f49;">${resp.student_name || resp.student_username || 'Unknown Student'}</h4>
                                    <span style="color: #666; font-size: 14px;">${new Date(resp.submitted_at).toLocaleString()}</span>
                                </div>
                                ${displayResponseData(responseData, activity.activity_type, config)}
                                ${resp.score !== null && resp.score !== undefined ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                                        <strong>Score:</strong> ${resp.score}
                                    </div>
                                ` : ''}
                                ${resp.feedback ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                                        <strong>Feedback:</strong> ${resp.feedback}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // If it's a poll activity, draw pie chart
                    if (activity.activity_type === 'poll') {
                        drawPollChart(responses, config);
                    }
                })
                .catch(error => {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #dc3545;">Failed to load activity information</p>';
                });
        }
        
        // Generate poll visualization
        function generatePollVisualization(responses, config) {
            const options = config.options || [];
            const optionCounts = {};
            const optionColors = ['#28a745', '#dc3545', '#007bff', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14'];
            
            // Initialize counts
            options.forEach((option, index) => {
                optionCounts[index] = 0;
            });
            
            // Count votes for each option
            responses.forEach(resp => {
                const responseData = resp.response_data || {};
                const optionIndex = responseData.option_index;
                if (optionIndex !== undefined && optionIndex !== null) {
                    const index = parseInt(optionIndex);
                    if (optionCounts[index] !== undefined) {
                        optionCounts[index]++;
                    }
                }
            });
            
            const totalVotes = responses.length;
            let html = `
                <div style="background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #082f49;">${config.question || 'Poll Results'}</h3>
                    <div style="display: flex; gap: 40px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 300px;">
                            <canvas id="pollChart" width="300" height="300" style="max-width: 100%;"></canvas>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        ${totalVotes}
                                    </div>
                                    <div>
                                        <strong style="font-size: 16px;">Total Participants</strong>
                                    </div>
                                </div>
                            </div>
                            <div style="display: grid; gap: 15px;">
            `;
            
            // Display statistics for each option
            options.forEach((option, index) => {
                const count = optionCounts[index] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;
                const color = optionColors[index % optionColors.length];
                
                html += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${color};">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: ${color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                            ${count}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px; color: #082f49;">${option}</div>
                            <div style="font-size: 14px; color: #666;">${percentage}% (${count} votes)</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // Draw poll pie chart
        function drawPollChart(responses, config) {
            const options = config.options || [];
            const optionCounts = {};
            const optionColors = ['#28a745', '#dc3545', '#007bff', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14'];
            
            // Initialize counts
            options.forEach((option, index) => {
                optionCounts[index] = 0;
            });
            
            // Count votes for each option
            responses.forEach(resp => {
                const responseData = resp.response_data || {};
                const optionIndex = responseData.option_index;
                if (optionIndex !== undefined && optionIndex !== null) {
                    const index = parseInt(optionIndex);
                    if (optionCounts[index] !== undefined) {
                        optionCounts[index]++;
                    }
                }
            });
            
            const canvas = document.getElementById('pollChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 2 - 20;
            
            const totalVotes = responses.length;
            let currentAngle = -Math.PI / 2; // Start from top
            
            // Draw pie chart
            options.forEach((option, index) => {
                const count = optionCounts[index] || 0;
                const percentage = totalVotes > 0 ? count / totalVotes : 0;
                const sliceAngle = percentage * 2 * Math.PI;
                const color = optionColors[index % optionColors.length];
                
                // Draw slice
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Display number in slice center
                if (count > 0) {
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius * 0.6);
                    const labelY = centerY + Math.sin(labelAngle) * (radius * 0.6);
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(count.toString(), labelX, labelY);
                }
                
                currentAngle += sliceAngle;
            });
        }
        
        // Document management related functions
        let currentCourseIdForDocuments = null;
        
        // Show document management interface
        async function showDocumentManagement(courseId) {
            currentCourseIdForDocuments = courseId;
            document.getElementById('documentManagementModal').style.display = 'block';
            await loadDocuments(courseId);
        }
        
        // Load documents list
        async function loadDocuments(courseId) {
            const container = document.getElementById('documentsList');
            container.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const response = await fetch(`/api/documents/course/${courseId}`);
                if (response.ok) {
                    const documents = await response.json();
                    displayDocuments(documents);
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p style="color: #dc3545;">Failed to load: ${error.error}</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p style="color: #dc3545;">Network error: ${error.message}</p>`;
            }
        }
        
        // Display documents list
        function displayDocuments(documents) {
            const container = document.getElementById('documentsList');
            
            if (documents.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No documents</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            documents.forEach(doc => {
                const statusBadge = doc.is_active 
                    ? '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Published</span>'
                    : '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Unpublished</span>';
                
                html += `
                    <div style="padding: 20px; border: 1px solid #e1e5e9; border-radius: 8px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 5px 0; color: #082f49;">${doc.title}</h4>
                                <p style="margin: 0; color: #666; font-size: 14px;">${doc.filename}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        ${doc.description ? `<p style="margin: 10px 0; color: #666; font-size: 14px;">${doc.description}</p>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <small style="color: #666;">
                                    <strong>Size:</strong> ${doc.file_size_mb} MB | 
                                    <strong>Type:</strong> ${doc.file_type.toUpperCase()} | 
                                    <strong>Downloads:</strong> ${doc.download_count} times
                                </small>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-primary" onclick="downloadDocument(${doc.id})" style="font-size: 12px; padding: 5px 10px;">Download</button>
                                <button class="btn btn-secondary" onclick="editDocument(${doc.id})" style="font-size: 12px; padding: 5px 10px;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteDocument(${doc.id})" style="font-size: 12px; padding: 5px 10px;">Delete</button>
                            </div>
                        </div>
                        <small style="color: #999; display: block; margin-top: 10px;">
                            Upload Time: ${new Date(doc.created_at).toLocaleString()}
                        </small>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Show upload form
        function showUploadDocumentForm() {
            document.getElementById('documentUploadForm').style.display = 'block';
            document.getElementById('documentTitle').value = '';
            document.getElementById('documentDescription').value = '';
            document.getElementById('documentFileInput').value = '';
            document.getElementById('documentUploadResult').innerHTML = '';
        }
        
        // Hide upload form
        function hideUploadDocumentForm() {
            document.getElementById('documentUploadForm').style.display = 'none';
        }
        
        // Upload document
        async function uploadDocument() {
            const fileInput = document.getElementById('documentFileInput');
            const titleInput = document.getElementById('documentTitle');
            const descriptionInput = document.getElementById('documentDescription');
            const resultDiv = document.getElementById('documentUploadResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div style="padding: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">Please select a file</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (titleInput.value.trim()) {
                formData.append('title', titleInput.value.trim());
            }
            if (descriptionInput.value.trim()) {
                formData.append('description', descriptionInput.value.trim());
            }
            
            resultDiv.innerHTML = '<div style="padding: 10px; color: #0c5460; background: #d1ecf1; border-radius: 5px;">Uploading...</div>';
            
            try {
                const response = await fetch(`/api/documents/course/${currentCourseIdForDocuments}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div style="padding: 10px; color: #155724; background: #d4edda; border-radius: 5px;">Upload successful!</div>';
                    fileInput.value = '';
                    titleInput.value = '';
                    descriptionInput.value = '';
                    await loadDocuments(currentCourseIdForDocuments);
                    setTimeout(() => {
                        hideUploadDocumentForm();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `<div style="padding: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">Upload failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="padding: 10px; color: #dc3545; background: #f8d7da; border-radius: 5px;">Network error: ${error.message}</div>`;
            }
        }
        
        // Download document
        function downloadDocument(documentId) {
            window.open(`/api/documents/${documentId}/download`, '_blank');
        }
        
        // Edit document
        async function editDocument(documentId) {
            try {
                const response = await fetch(`/api/documents/${documentId}`);
                if (response.ok) {
                    const doc = await response.json();
                    const newTitle = prompt('Document Title:', doc.title);
                    if (newTitle === null) return;
                    
                    const newDescription = prompt('Document Description:', doc.description || '');
                    if (newDescription === null) return;
                    
                    const isActive = confirm(`Current Status: ${doc.is_active ? 'Published' : 'Unpublished'}\n\nPublish?`);
                    
                    const updateData = {
                        title: newTitle,
                        description: newDescription,
                        is_active: isActive
                    };
                    
                    const updateResponse = await fetch(`/api/documents/${documentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (updateResponse.ok) {
                        showMessage('Document updated successfully', 'success');
                        await loadDocuments(currentCourseIdForDocuments);
                    } else {
                        const error = await updateResponse.json();
                        showMessage(`Update failed: ${error.error}`, 'error');
                    }
                } else {
                    const error = await response.json();
                    showMessage(`Failed to load: ${error.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Network error: ${error.message}`, 'error');
            }
        }
        
        // Delete document
        async function deleteDocument(documentId) {
            if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Document deleted', 'success');
                    await loadDocuments(currentCourseIdForDocuments);
                } else {
                    const error = await response.json();
                    showMessage(`Delete failed: ${error.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Network error: ${error.message}`, 'error');
            }
        }
        
        // AI Assistant related functions
        let currentCourseIdForAI = null;
        
        // Show AI Assistant interface
        async function showAIAssistant(courseId) {
            currentCourseIdForAI = courseId;
            
            // Get course information
            try {
                const response = await fetch(`/api/courses/${courseId}`);
                if (response.ok) {
                    const course = await response.json();
                    document.getElementById('aiAssistantCourseName').textContent = `${course.course_name} (${course.course_code})`;
                }
            } catch (error) {
                document.getElementById('aiAssistantCourseName').textContent = 'Unknown Course';
            }
            
            // Clear chat history
            document.getElementById('aiChatMessages').innerHTML = `
                <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                    <strong>AI Assistant:</strong> Hello! I'm an AI course assistant, and I can help you answer questions about the course. I can provide assistance based on course materials, activity content, and other information. Please feel free to ask!
                </div>
            `;
            
            // Clear input field
            document.getElementById('aiQuestionInput').value = '';
            
            // Show modal
            document.getElementById('aiAssistantModal').style.display = 'block';
        }
        
        // Ask AI a question
        async function askAIQuestion() {
            const questionInput = document.getElementById('aiQuestionInput');
            const question = questionInput.value.trim();
            
            if (!question) {
                showMessage('Please enter your question', 'error');
                return;
            }
            
            if (!currentCourseIdForAI) {
                showMessage('Course information error', 'error');
                return;
            }
            
            const messagesContainer = document.getElementById('aiChatMessages');
            const loadingIndicator = document.getElementById('aiLoadingIndicator');
            
            // Display user question
            messagesContainer.innerHTML += `
                <div style="padding: 10px; background: #d4edda; border-radius: 8px; margin-bottom: 10px; text-align: right;">
                    <strong>You:</strong> ${question}
                </div>
            `;
            
            // Clear input field
            questionInput.value = '';
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Scroll to bottom
            const chatContainer = document.getElementById('aiChatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch(`/api/ai-qa/course/${currentCourseIdForAI}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question })
                });
                
                loadingIndicator.style.display = 'none';
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Display AI answer
                    messagesContainer.innerHTML += `
                        <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>AI Assistant:</strong> ${result.answer.replace(/\n/g, '<br>')}
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    messagesContainer.innerHTML += `
                        <div style="padding: 10px; background: #f8d7da; border-radius: 8px; margin-bottom: 10px; color: #dc3545;">
                            <strong>Error:</strong> ${error.error || 'Request failed'}
                        </div>
                    `;
                }
            } catch (error) {
                loadingIndicator.style.display = 'none';
                messagesContainer.innerHTML += `
                    <div style="padding: 10px; background: #f8d7da; border-radius: 8px; margin-bottom: 10px; color: #dc3545;">
                        <strong>Error:</strong> Network error: ${error.message}
                    </div>
                `;
            }
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // General AI Assistant related functions
        // Show general AI Assistant interface
        function showGeneralAIAssistant() {
            setActiveSidebar(3);
            // Clear chat history
            document.getElementById('generalAIChatMessages').innerHTML = `
                <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                    <strong>AI Assistant:</strong> Hello! I'm a general AI assistant, and I can help you answer various questions. If you have questions about a specific course, I will guide you to use that course's AI assistant. Please feel free to ask!
                </div>
            `;
            
            // Clear input field
            document.getElementById('generalAIQuestionInput').value = '';
            
            // Show modal
            document.getElementById('generalAIAssistantModal').style.display = 'block';
        }
        
        // Ask general AI a question
        async function askGeneralAIQuestion() {
            const questionInput = document.getElementById('generalAIQuestionInput');
            const question = questionInput.value.trim();
            
            if (!question) {
                showMessage('Please enter your question', 'error');
                return;
            }
            
            const messagesContainer = document.getElementById('generalAIChatMessages');
            const loadingIndicator = document.getElementById('generalAILoadingIndicator');
            
            // Display user question
            messagesContainer.innerHTML += `
                <div style="padding: 10px; background: #d4edda; border-radius: 8px; margin-bottom: 10px; text-align: right;">
                    <strong>You:</strong> ${question}
                </div>
            `;
            
            // Clear input field
            questionInput.value = '';
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Scroll to bottom
            const chatContainer = document.getElementById('generalAIChatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/ai-qa/general/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question })
                });
                
                loadingIndicator.style.display = 'none';
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Display AI answer
                    messagesContainer.innerHTML += `
                        <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>AI Assistant:</strong> ${result.answer.replace(/\n/g, '<br>')}
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    messagesContainer.innerHTML += `
                        <div style="padding: 10px; background: #f8d7da; border-radius: 8px; margin-bottom: 10px; color: #dc3545;">
                            <strong>Error:</strong> ${error.error || 'Request failed'}
                        </div>
                    `;
                }
            } catch (error) {
                loadingIndicator.style.display = 'none';
                messagesContainer.innerHTML += `
                    <div style="padding: 10px; background: #f8d7da; border-radius: 8px; margin-bottom: 10px; color: #dc3545;">
                        <strong>Error:</strong> Network error: ${error.message}
                    </div>
                `;
            }
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Display response data
        function displayResponseData(responseData, activityType, config) {
            let html = '';
            
            if (activityType === 'poll') {
                html += `<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Selected Option:</strong> ${responseData.selected_option || responseData.option_index !== undefined ? 
                        (config.options && config.options[responseData.option_index] ? config.options[responseData.option_index] : responseData.selected_option) : 
                        'Not selected'}
                </div>`;
            } else if (activityType === 'quiz') {
                if (responseData.answers && Array.isArray(responseData.answers)) {
                    // Multiple questions format
                    const questions = config.questions || [];
                    html += '<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">';
                    responseData.answers.forEach((answer, index) => {
                        const question = questions[index];
                        const isCorrect = answer.is_correct;
                        const selectedOption = question && question.options && answer.option_index !== undefined 
                            ? question.options[answer.option_index] 
                            : answer.selected_option || 'Not selected';
                        
                        html += `<div style="margin-bottom: ${index < responseData.answers.length - 1 ? '15px' : '0'}; padding-bottom: ${index < responseData.answers.length - 1 ? '15px' : '0'}; border-bottom: ${index < responseData.answers.length - 1 ? '1px solid #dee2e6' : 'none'};">`;
                        html += `<strong>Question ${index + 1}:</strong> ${question ? question.question : 'Unknown'}<br>`;
                        html += `<strong>Selected Answer:</strong> ${selectedOption}`;
                        if (isCorrect !== undefined) {
                            html += `<br><strong>Result:</strong> <span style="color: ${isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                ${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                            </span>`;
                            if (!isCorrect && question && question.correct_answer !== undefined && question.options) {
                                html += `<br><strong>Correct Answer:</strong> <span style="color: #28a745;">${question.options[question.correct_answer]}</span>`;
                            }
                        }
                        html += `</div>`;
                    });
                    
                    // Calculate and display overall score
                    const correctCount = responseData.answers.filter(a => a.is_correct).length;
                    const totalQuestions = responseData.answers.length;
                    const percentage = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
                    html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #082f49; font-weight: bold; color: #082f49;">
                        Overall Score: ${correctCount}/${totalQuestions} (${percentage}%)
                    </div>`;
                    html += '</div>';
                } else {
                    // Old single question format (backward compatibility)
                    html += `<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>Selected Option:</strong> ${responseData.selected_option || (config.options && responseData.option_index !== undefined ? config.options[responseData.option_index] : 'Not selected')}
                        ${responseData.is_correct !== undefined ? `
                            <br><strong>Is Correct:</strong> <span style="color: ${responseData.is_correct ? '#28a745' : '#dc3545'}">
                                ${responseData.is_correct ? '‚úì Correct' : '‚úó Incorrect'}
                            </span>
                        ` : ''}
                    </div>`;
                }
            } else if (activityType === 'word_cloud') {
                const words = responseData.words || [];
                html += `<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Submitted Keywords:</strong> ${words.length > 0 ? words.join(', ') : 'None'}
                </div>`;
            } else if (activityType === 'short_answer') {
                html += `<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Answer:</strong><br>
                    <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 5px; white-space: pre-wrap;">${responseData.answer || 'None'}</div>
                </div>`;
            } else {
                html += `<div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <pre style="white-space: pre-wrap; margin: 0;">${JSON.stringify(responseData, null, 2)}</pre>
                </div>`;
            }
            
            return html;
        }

        // Forum functions
        let currentForumCourseId = null;
        let currentViewingPostId = null;

        async function openForumModal(courseId, courseName) {
            currentForumCourseId = courseId;
            document.getElementById('forumCourseName').textContent = courseName;
            document.getElementById('forumModal').style.display = 'block';
            await loadForumPosts(courseId);
            await markForumAsRead(courseId);
        }

        async function loadForumPosts(courseId, page = 1, perPage = 10) {
            const postsList = document.getElementById('forumPostsList');
            postsList.innerHTML = '<div class="loading">Loading forum posts...</div>';
            
            try {
                const response = await fetch(`/api/forum/${courseId}?page=${page}&per_page=${perPage}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                postsList.innerHTML = '';
                
                if (data.posts.length === 0) {
                    postsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No posts yet. Be the first to create one!</p>';
                    return;
                }
                
                data.posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'forum-post';
                    postElement.style.cssText = `
                        border: 1px solid #e1e5e9;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        background: #fff;
                    `;
                    
                    postElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <h4 style="margin: 0; color: #333;">${post.title}</h4>
                                <small style="color: #666;">By ${post.user_name || 'Unknown'} on ${new Date(post.created_at).toLocaleString()}</small>
                            </div>
                            <div>
                                ${post.is_pinned ? '<span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 12px;">üìå Pinned</span>' : ''}
                            </div>
                        </div>
                        <div style="margin-bottom: 10px; color: #555;">${post.content}</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadPostDetails(${post.id})">View Replies (${post.reply_count})</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="replyToPost(${post.id})">Reply</button>
                            ${post.can_delete ? `<button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})">Delete</button>` : ''}
                        </div>
                    `;
                    
                    postsList.appendChild(postElement);
                });
                
                // Add pagination if needed
                if (data.total_pages > 1) {
                    const pagination = document.createElement('div');
                    pagination.style.cssText = 'text-align: center; margin-top: 20px;';
                    pagination.innerHTML = `
                        <button class="btn btn-sm btn-outline-primary" ${page <= 1 ? 'disabled' : ''} onclick="loadForumPosts(${courseId}, ${page - 1})">Previous</button>
                        <span style="margin: 0 10px;">Page ${page} of ${data.total_pages}</span>
                        <button class="btn btn-sm btn-outline-primary" ${page >= data.total_pages ? 'disabled' : ''} onclick="loadForumPosts(${courseId}, ${page + 1})">Next</button>
                    `;
                    postsList.appendChild(pagination);
                }
                
            } catch (error) {
                postsList.innerHTML = `<div style="padding: 20px; background: #f8d7da; border-radius: 8px; color: #dc3545;">Error loading posts: ${error.message}</div>`;
            }
        }

        async function createForumPost() {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            
            if (!title || !content) {
                alert('Please fill in both title and content.');
                return;
            }
            
            try {
                const response = await fetch(`/api/forum/${currentForumCourseId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Clear form and close modal
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                closeModal('createPostModal');
                
                // Reload posts
                await loadForumPosts(currentForumCourseId);
                
            } catch (error) {
                alert(`Error creating post: ${error.message}`);
            }
        }

        async function replyToPost(postId) {
            const replyContent = prompt('Enter your reply:');
            if (!replyContent || !replyContent.trim()) return;
            
            try {
                const response = await fetch(`/api/forum/post/${postId}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: replyContent.trim()
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Reload posts to show updated reply count
                await loadForumPosts(currentForumCourseId);
                
                // If the post details modal is currently open and showing this post, reload it too
                const postDetailsModal = document.getElementById('postDetailsModal');
                if (postDetailsModal && postDetailsModal.style.display === 'block' && currentViewingPostId === postId) {
                    await loadPostDetails(postId);
                }
                
            } catch (error) {
                alert(`Error posting reply: ${error.message}`);
            }
        }

        async function loadPostDetails(postId) {
            currentViewingPostId = postId;
            const container = document.getElementById('postDetailsContent');
            container.innerHTML = '<div class="loading">Loading post details...</div>';
            document.getElementById('postDetailsModal').style.display = 'block';
            
            try {
                const response = await fetch(`/api/forum/post/${postId}/replies`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                displayPostDetails(data.post, data.replies);
                
            } catch (error) {
                container.innerHTML = `<div style="padding: 20px; background: #f8d7da; border-radius: 8px; color: #dc3545;">Error loading post details: ${error.message}</div>`;
            }
        }

        function displayPostDetails(post, replies) {
            const container = document.getElementById('postDetailsContent');
            
            let html = `
                <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #082f49;">${post.title}</h3>
                            <small style="color: #666;">By ${post.user_name || 'Unknown'} on ${new Date(post.created_at).toLocaleString()}</small>
                        </div>
                        <div>
                            ${post.is_pinned ? '<span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 3px; font-size: 12px;">üìå Pinned</span>' : ''}
                        </div>
                    </div>
                    <div style="color: #333; line-height: 1.6; margin-bottom: 15px;">${post.content.replace(/\n/g, '<br>')}</div>
                    <div style="border-top: 1px solid #e1e5e9; padding-top: 15px;">
                        <button class="btn btn-sm btn-outline-secondary" onclick="replyToPost(${post.id})">Reply to Post</button>
                        ${post.can_delete ? `<button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})" style="margin-left: 10px;">Delete Post</button>` : ''}
                    </div>
                </div>
            `;
            
            if (replies.length === 0) {
                html += '<p style="text-align: center; padding: 20px; color: #666;">No replies yet. Be the first to reply!</p>';
            } else {
                html += '<h4 style="margin-bottom: 15px; color: #082f49;">Replies</h4>';
                html += '<div class="replies-container">';
                
                // Display threaded replies
                replies.forEach(reply => {
                    html += renderReply(reply, 0);
                });
                
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function renderReply(reply, depth) {
            const indent = depth * 30; // 30px indent per level
            const maxDepth = 2; // Limit nesting depth to 3 layers (depth 0, 1, 2)
            
            let html = `
                <div class="reply" style="margin-left: ${indent}px; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f8f9fa;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #082f49;">${reply.user_name || 'Unknown'}</strong>
                            <small style="color: #666; margin-left: 10px;">${new Date(reply.created_at).toLocaleString()}</small>
                        </div>
                    </div>
                    <div style="color: #333; line-height: 1.5; margin-bottom: 10px;">${reply.content.replace(/\n/g, '<br>')}</div>
                    <div style="display: flex; gap: 10px;">
                        ${depth < maxDepth ? `<button class="btn btn-sm btn-outline-secondary" onclick="replyToReply(${reply.id}, '${reply.user_name || 'Unknown'}')">Reply</button>` : '<small style="color: #999; font-style: italic;">Maximum reply depth reached</small>'}
                        ${reply.can_delete ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteReply(${reply.id})">Delete</button>` : ''}
                    </div>
                </div>
            `;
            
            // Render child replies
            if (reply.child_replies && reply.child_replies.length > 0) {
                reply.child_replies.forEach(childReply => {
                    html += renderReply(childReply, depth + 1);
                });
            }
            
            return html;
        }

        async function replyToReply(parentReplyId, parentAuthorName) {
            const replyContent = prompt(`Reply to ${parentAuthorName}:`);
            if (!replyContent || !replyContent.trim()) return;
            
            try {
                const response = await fetch(`/api/forum/post/${currentViewingPostId}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: replyContent.trim(),
                        parent_reply_id: parentReplyId
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Reload the post details to show the new reply
                await loadPostDetails(currentViewingPostId);
                
            } catch (error) {
                alert(`Error posting reply: ${error.message}`);
            }
        }

        async function markForumAsRead(courseId) {
            try {
                await fetch(`/api/forum/${courseId}/mark-read`, { method: 'POST' });
                // Update the forum button to remove notification indicator
                const forumBtn = document.querySelector(`[data-course-id="${courseId}"] .forum-btn`);
                if (forumBtn) {
                    forumBtn.innerHTML = 'üí¨ Forum';
                }
            } catch (error) {
                console.error('Error marking forum as read:', error);
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/forum/post/${postId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Reload the forum posts to show the updated content
                await loadForumPosts(currentForumCourseId);
                
                // If the post details modal is currently open and showing this post, reload it too
                const postDetailsModal = document.getElementById('postDetailsModal');
                if (postDetailsModal && postDetailsModal.style.display === 'block' && currentViewingPostId === postId) {
                    await loadPostDetails(postId);
                }
                
            } catch (error) {
                alert(`Error deleting post: ${error.message}`);
            }
        }

        async function deleteReply(replyId) {
            if (!confirm('Are you sure you want to delete this reply? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/forum/reply/${replyId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                // Reload the post details to show the updated content
                if (currentViewingPostId) {
                    await loadPostDetails(currentViewingPostId);
                }
                
            } catch (error) {
                alert(`Error deleting reply: ${error.message}`);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    </script>
</body>
</html>
