<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Smart Classroom Platform</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="/static/js/i18n.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* General styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background: #f5f6fa;
            color: #222;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #082f49;
            color: #fff;
            padding: 15px 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        header h1::before {
            content: "‚öôÔ∏è";
            font-size: 22px;
        }

        header .nav-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lang-switch {
            background: #fff;
            color: #082f49;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn {
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            cursor: pointer;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        /* Metrics card layout */
        .metrics {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            flex: 1;
            background: #083d5d;
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }

        .metric-card h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .metric-card p {
            font-size: 28px;
            font-weight: bold;
        }

        /* Section title */
        section h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #082f49;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Card block */
        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.05);
        }

        .card .loading {
            color: #999;
            text-align: center;
            padding: 10px 0;
        }

        button.primary {
            background-color: #083d5d;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        button.primary:hover {
            background-color: #0b4b70;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            main {
                padding: 20px;
            }

            .metrics {
                flex-direction: column;
            }
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .role-teacher {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .role-student {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .role-admin {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-placeholder {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1em;
        }
        
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .action-card:hover {
            transform: translateY(-2px);
        }
        
        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .action-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .action-description {
            color: #666;
            font-size: 0.9em;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .chart-switch-btn {
            margin-right: 10px;
            background-color: #f8f9fa;
            color: #082f49;
            border: 2px solid #e1e5e9;
        }
        
        .chart-switch-btn.active {
            background-color: #083d5d;
            color: white;
            border-color: #083d5d;
        }
        
        .chart-switch-btn:hover {
            background-color: #0b4b70;
            color: white;
            border-color: #0b4b70;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="platform-logo" style="display: flex; align-items: center;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 260 90" style="height:40px;">
                    <!-- Background hexagon outline (PolyU style) -->
                    <polygon points="30,45 50,15 90,15 110,45 90,75 50,75" fill="none" stroke="#ff6b6b" stroke-width="3"/>

                    <!-- Open book (education) -->
                    <path d="M60 40 Q75 25 90 40 Q105 55 120 40 Q135 25 150 40" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" />

                    <!-- Book spine -->
                    <line x1="105" y1="40" x2="105" y2="70" stroke="#ffffff" stroke-width="3"/>

                    <!-- Circuit nodes (technology connection lines) -->
                    <circle cx="75" cy="28" r="3" fill="#4facfe"/>
                    <circle cx="135" cy="28" r="3" fill="#4facfe"/>
                    <line x1="75" y1="28" x2="135" y2="28" stroke="#4facfe" stroke-width="2" stroke-dasharray="4 3"/>

                    <!-- Light bulb on book -->
                    <circle cx="105" cy="18" r="4" fill="#ffd54f"/>

                    <!-- Text section -->
                    <text x="160" y="42" font-size="18" font-family="Inter, PingFang SC, sans-serif" font-weight="700" fill="#ffffff">PolyLearn</text>
                    <text x="160" y="65" font-size="12" font-family="Inter, sans-serif" fill="#b0bec5">Smart Learning</text>
                </svg>
            </div>
            <h1 style="margin: 0;">Admin Dashboard</h1>
        </div>
        <div class="nav-actions">
            <button id="languageToggle" class="lang-switch" onclick="toggleLanguage()">
                üåê EN
            </button>
            <span id="userName">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>
    
    <main>
        <!-- Data Metrics -->
        <div class="metrics">
            <div class="metric-card">
                <h3>Total Users</h3>
                <p id="totalUsers">0</p>
            </div>
            <div class="metric-card">
                <h3>Total Courses</h3>
                <p id="totalCourses">0</p>
            </div>
            <div class="metric-card">
                <h3>Total Activities</h3>
                <p id="totalActivities">0</p>
            </div>
            <div class="metric-card">
                <h3>Total Responses</h3>
                <p id="totalResponses">0</p>
            </div>
            <div class="metric-card">
                <h3>Active Users</h3>
                <p id="activeUsers">0</p>
            </div>
            <div class="metric-card">
                <h3>AI Activities</h3>
                <p id="aiActivities">0</p>
            </div>
        </div>
        
        <!-- User Management -->
        <section class="card">
            <h2>User Management</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="primary" onclick="showUserManagement()">Manage Users</button>
                <button class="primary" onclick="showImportUsers()" style="background: #28a745;">Import Users (Excel)</button>
            </div>
            <div id="usersList" class="loading">Loading...</div>
        </section>

        <!-- Course Management -->
        <section class="card">
            <h2>Course Management</h2>
            <button class="primary" onclick="showCourseManagement()">Manage Courses</button>
            <div id="coursesManagementList" class="loading">Loading...</div>
        </section>

        <!-- Activity Management -->
        <section class="card">
            <h2>Activity Management</h2>
            <button class="primary" onclick="showActivityManagement()">Manage Activities</button>
            <div id="activitiesManagementList" class="loading">Loading...</div>
        </section>

        <!-- System Overview -->
        <section class="card">
            <h2>System Overview</h2>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; flex-direction: column;">
                        <label for="startDate" style="font-size: 0.9em; font-weight: 500; margin-bottom: 5px;">Start Date:</label>
                        <input type="date" id="startDate" style="padding: 8px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label for="endDate" style="font-size: 0.9em; font-weight: 500; margin-bottom: 5px;">End Date:</label>
                        <input type="date" id="endDate" style="padding: 8px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="display: flex; align-items: end; gap: 10px;">
                        <button class="primary" onclick="loadSystemOverview()" style="padding: 8px 16px; height: 38px;">Apply Date Range</button>
                        <button class="primary" onclick="clearDateRange()" style="padding: 8px 16px; height: 38px; background-color: #6c757d;">Clear</button>
                    </div>
                </div>
                <div>
                    <button id="completionBtn" class="primary chart-switch-btn active" onclick="switchChart('completion')">Completion Rates</button>
                    <button id="timeBtn" class="primary chart-switch-btn" onclick="switchChart('time')">Time Spent</button>
                    <button id="quizBtn" class="primary chart-switch-btn" onclick="switchChart('quiz')">Quiz Scores</button>
                    <button id="userActivityBtn" class="primary chart-switch-btn" onclick="switchChart('userActivity')">User Activity</button>
                </div>
            </div>
            <div id="systemOverview">
                <div id="completionChartContainer" class="chart-container">
                    <div class="chart-title">Course Completion Rates</div>
                    <canvas id="completionRateChart"></canvas>
                </div>
                <div id="timeChartContainer" class="chart-container" style="display: none;">
                    <div class="chart-title">Time Spent on Modules (Average per User)</div>
                    <canvas id="timeSpentChart"></canvas>
                </div>
                <div id="quizChartContainer" class="chart-container" style="display: none;">
                    <div class="chart-title">Quiz Scores</div>
                    <canvas id="quizScoreChart"></canvas>
                </div>
                <div id="userActivityChartContainer" class="chart-container" style="display: none;">
                    <div class="chart-title">User Activity Over Time</div>
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <footer>
        Smart Classroom Platform ¬© 2025
    </footer>
    
    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userManagementModal')">&times;</span>
            <h2>User Management</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadUsers()">Refresh Users</button>
                <button class="btn btn-success" onclick="showCreateUserModal()">Create User</button>
            </div>
            <div id="usersList" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- Import Users Modal -->
    <div id="importUsersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('importUsersModal')">&times;</span>
            <h2>Import Users (Excel)</h2>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 5px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">Excel File Format Requirements:</h3>
                <p><strong>Required Columns:</strong></p>
                <ul>
                    <li><code>username</code> - Username (unique)</li>
                    <li><code>full_name</code> - Full Name</li>
                    <li><code>email</code> - Email (unique)</li>
                    <li><code>role</code> - Role (student or teacher)</li>
                </ul>
                <p><strong>Optional Columns:</strong></p>
                <ul>
                    <li><code>department</code> - Department</li>
                    <li><code>student_id</code> - Student ID (required when role is student)</li>
                    <li><code>course_code</code> - Course Code (students only, for automatic course enrollment)</li>
                </ul>
                <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>Note:</strong> Default password for all newly created users is <code>123456</code>
                </p>
                <p style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 5px;">
                    <strong>Email Format Requirement:</strong> Email must end with <code>@connect.polyu.hk</code> (e.g., <code>24085316G@connect.polyu.hk</code>)
                </p>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; border: 2px dashed #4facfe;">
                <input type="file" id="adminExcelFileInput" accept=".xlsx,.xls" style="margin-bottom: 15px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <button class="btn btn-success" onclick="importUsersFromExcel()" style="width: 100%; padding: 12px; font-size: 16px;">
                    Upload and Import Users
                </button>
                <div id="adminExcelImportResult" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createUserModal')">&times;</span>
            <h2>Create User</h2>
            <form id="createUserForm">
                <div class="form-group">
                    <label for="userUsername">Username:</label>
                    <input type="text" id="userUsername" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" placeholder="e.g., 24085316G@connect.polyu.hk" required>
                    <small style="color: #666; font-size: 12px;">Email must end with @connect.polyu.hk</small>
                </div>
                <div class="form-group">
                    <label for="userFullName">Full Name:</label>
                    <input type="text" id="userFullName" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role:</label>
                    <select id="userRole" required>
                        <option value="">Select Role</option>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password:</label>
                    <input type="password" id="userPassword" placeholder="Enter password" required>
                </div>
                <div class="form-group">
                    <label for="userStudentId">Student ID (Students Only):</label>
                    <input type="text" id="userStudentId" placeholder="Enter student ID">
                </div>
                <div class="form-group">
                    <label for="userDepartment">Department:</label>
                    <input type="text" id="userDepartment" placeholder="Enter department">
                </div>
                <button type="submit" class="btn">Create User</button>
            </form>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            <h2>Edit User</h2>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserUsername">Username:</label>
                    <input type="text" id="editUserUsername" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="editUserEmail">Email:</label>
                    <input type="email" id="editUserEmail" placeholder="e.g., 24085316G@connect.polyu.hk" required>
                    <small style="color: #666; font-size: 12px;">Email must end with @connect.polyu.hk</small>
                </div>
                <div class="form-group">
                    <label for="editUserFullName">Full Name:</label>
                    <input type="text" id="editUserFullName" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label for="editUserRole">Role:</label>
                    <select id="editUserRole" required>
                        <option value="">Select Role</option>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserStudentId">Student ID (Students Only):</label>
                    <input type="text" id="editUserStudentId" placeholder="Enter student ID">
                </div>
                <div class="form-group">
                    <label for="editUserDepartment">Department:</label>
                    <input type="text" id="editUserDepartment" placeholder="Enter department">
                </div>
                <button type="submit" class="btn">Save Changes</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Course Modal -->
    <div id="editCourseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editCourseModal')">&times;</span>
            <h2>Edit Course</h2>
            <form id="editCourseForm">
                <input type="hidden" id="editCourseId">
                <div class="form-group">
                    <label for="editCourseName">Course Name:</label>
                    <input type="text" id="editCourseName" placeholder="Enter course name" required>
                </div>
                <div class="form-group">
                    <label for="editCourseCode">Course Code:</label>
                    <input type="text" id="editCourseCode" placeholder="Enter course code" required>
                </div>
                <div class="form-group">
                    <label for="editCourseDescription">Course Description:</label>
                    <textarea id="editCourseDescription" placeholder="Enter course description" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editCourseActive">Status:</label>
                    <select id="editCourseActive" required>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn">Save Changes</button>
            </form>
        </div>
    </div>
    
    <!-- Course Management Modal -->
    <div id="courseManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('courseManagementModal')">&times;</span>
            <h2>Course Management</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadCourses()">Refresh Courses</button>
            </div>
            <div id="coursesManagementList" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- Activity Management Modal -->
    <div id="activityManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('activityManagementModal')">&times;</span>
            <h2>Activity Management</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadActivities()">Refresh Activities</button>
            </div>
            <div id="activitiesManagementList" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- System Logs Modal -->
    <div id="systemLogsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('systemLogsModal')">&times;</span>
            <h2>System Logs</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadSystemLogs()">Refresh Logs</button>
            </div>
            <div id="systemLogsList" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let systemOverviewData = null;
        let currentChart = 'completion';
        
        // Initialize on page load
        window.onload = async function() {
            // Set default date range (last 12 months)
            setDefaultDateRange();
            
            await checkAuth();
            await loadDashboardData();
            await loadSystemOverview();
            // Auto-load users, courses, and activities lists
            await loadUsers();
            await loadCourses();
            await loadActivities();
            // Bind edit form submit events
            bindEditFormEvents();
            // Bind create user form submit event
            bindCreateUserFormEvent();
        };
        
        // Bind edit form submit events (on page load)
        function bindEditFormEvents() {
            // Bind once on initialization, but mainly rebind when opening modals
            bindEditUserFormEvent();
            bindEditCourseFormEvent();
        }
        
        // Check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/profile', {
                    credentials: 'include'
                });
                if (response.ok) {
                    currentUser = await response.json();
                    if (currentUser.role !== 'admin') {
                        window.location.href = '/login';
                        return;
                    }
                    document.getElementById('userName').textContent = currentUser.full_name;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/analytics/dashboard', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalUsers').textContent = data.stats.total_users;
                    document.getElementById('totalCourses').textContent = data.stats.total_courses;
                    document.getElementById('totalActivities').textContent = data.stats.total_activities;
                    document.getElementById('totalResponses').textContent = data.stats.total_responses;
                    document.getElementById('activeUsers').textContent = data.stats.active_users;
                    document.getElementById('aiActivities').textContent = data.stats.ai_activities;
                    
                    // Display user role distribution
                    displayRoleChart(data.role_stats);
                    
                    // Display recently registered users
                    displayRecentUsers(data.recent_users);
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }
        
        // Display user role distribution
        function displayRoleChart(roleStats) {
            const container = document.getElementById('roleChart');
            if (!roleStats || roleStats.length === 0) {
                container.innerHTML = '<p>No data</p>';
                return;
            }
            
            const html = roleStats.map(stat => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e1e5e9;">
                    <span>${getRoleName(stat.role)}</span>
                    <span style="font-weight: bold; color: #4facfe;">${stat.count}</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Display recently registered users
        function displayRecentUsers(users) {
            const container = document.getElementById('recentUsers');
            if (!users || users.length === 0) {
                container.innerHTML = '<p>No users</p>';
                return;
            }
            
            const html = users.map(user => `
                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 10px;">
                    <h4>${user.full_name} (@${user.username})</h4>
                    <p>Role: <span class="role-badge role-${user.role}">${getRoleName(user.role)}</span></p>
                    <p>Email: ${user.email}</p>
                    <p>Registered: ${new Date(user.created_at).toLocaleString()}</p>
                    <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete User</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Set default date range (last 12 months)
        function setDefaultDateRange() {
            const now = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(now.getFullYear() - 1);
            
            // Format dates as YYYY-MM-DD for input fields
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            document.getElementById('startDate').value = formatDate(oneYearAgo);
            document.getElementById('endDate').value = formatDate(now);
        }
        
        // Clear date range
        function clearDateRange() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            // Reload with default date range
            loadSystemOverview();
        }
        
        // Load system overview data
        async function loadSystemOverview() {
            try {
                // Show loading state
                document.getElementById('systemOverview').innerHTML = '<div class="loading">Loading system overview...</div>';
                
                // Get date range from inputs
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                // Build query parameters
                const params = new URLSearchParams();
                if (startDate) {
                    params.append('start_date', startDate);
                }
                if (endDate) {
                    params.append('end_date', endDate);
                }
                
                // Fetch system overview data
                const response = await fetch(`/api/admin/system-overview?${params.toString()}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    systemOverviewData = await response.json();
                    
                    // Restore chart containers HTML
                    document.getElementById('systemOverview').innerHTML = `
                        <div id="completionChartContainer" class="chart-container">
                            <div class="chart-title">Course Completion Rates</div>
                            <canvas id="completionRateChart"></canvas>
                        </div>
                        <div id="timeChartContainer" class="chart-container" style="display: none;">
                            <div class="chart-title">Time Spent on Modules (Average per User)</div>
                            <canvas id="timeSpentChart"></canvas>
                        </div>
                        <div id="quizChartContainer" class="chart-container" style="display: none;">
                            <div class="chart-title">Quiz Scores</div>
                            <canvas id="quizScoreChart"></canvas>
                        </div>
                        <div id="userActivityChartContainer" class="chart-container" style="display: none;">
                            <div class="chart-title">User Activity Over Time</div>
                            <canvas id="userActivityChart"></canvas>
                        </div>
                    `;
                    
                    // Render the current chart
                    switchChart(currentChart);
                } else {
                    const error = await response.json();
                    document.getElementById('systemOverview').innerHTML = `<div class="error">Failed to load system overview: ${error.error}</div>`;
                }
            } catch (error) {
                console.error('Failed to load system overview:', error);
                document.getElementById('systemOverview').innerHTML = '<div class="error">Failed to load system overview</div>';
            }
        }
        
        // Switch between charts
        function switchChart(chartType) {
            if (!systemOverviewData) return;
            
            // Update button states
            document.querySelectorAll('.chart-switch-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(chartType + 'Btn').classList.add('active');
            
            // Hide all chart containers
            document.getElementById('completionChartContainer').style.display = 'none';
            document.getElementById('timeChartContainer').style.display = 'none';
            document.getElementById('quizChartContainer').style.display = 'none';
            document.getElementById('userActivityChartContainer').style.display = 'none';
            
            // Show selected chart container
            document.getElementById(chartType + 'ChartContainer').style.display = 'block';
            
            // Render the selected chart if not already rendered
            currentChart = chartType;
            switch (chartType) {
                case 'completion':
                    renderCompletionRateChart(systemOverviewData);
                    break;
                case 'time':
                    renderTimeSpentChart(systemOverviewData);
                    break;
                case 'quiz':
                    renderQuizScoreChart(systemOverviewData);
                    break;
                case 'userActivity':
                    renderUserActivityChart(systemOverviewData);
                    break;
            }
        }
        
        // Render completion rate chart
        function renderCompletionRateChart(data) {
            const canvas = document.getElementById('completionRateChart');
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const courseNames = data.course_breakdown.map(course => course.course_code);
            const completionRates = data.course_breakdown.map(course => course.completion_rate);
            
            canvas.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: courseNames,
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: completionRates,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Course Code'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Rate (%)'
                            }
                        }
                    }
                }
            });
        }
        
        // Render time spent chart
        function renderTimeSpentChart(data) {
            const canvas = document.getElementById('timeSpentChart');
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const courseNames = data.course_breakdown.map(course => course.course_code);
            const avgTimes = data.course_breakdown.map(course => course.avg_time_per_user_seconds / 60); // Convert to minutes
            
            canvas.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: courseNames,
                    datasets: [{
                        label: 'Average Time Spent (minutes)',
                        data: avgTimes,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Course Code'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Time Spent (minutes)'
                            }
                        }
                    }
                }
            });
        }
        
        // Render quiz score chart
        function renderQuizScoreChart(data) {
            const canvas = document.getElementById('quizScoreChart');
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const courseLabels = ['Courses']; // Single label for all bars
            const courseNames = data.course_breakdown.map(course => course.course_name);
            const courseCodes = data.course_breakdown.map(course => course.course_code);
            const avgScores = data.course_breakdown.map(course => course.avg_quiz_score);
            
            // Create separate datasets for each course to enable individual legend toggling
            const datasets = data.course_breakdown.map((course, index) => ({
                label: `${course.course_code} - ${course.course_name}`,
                data: [course.avg_quiz_score],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ][index % 6],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ][index % 6],
                borderWidth: 1
            }));
            
            canvas.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: courseLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Courses'
                            },
                            ticks: {
                                display: false // Hide x-axis ticks since we only have one label
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Average Quiz Score (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Average Quiz Scores by Course',
                            position: 'top'
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                boxWidth: 12,
                                boxHeight: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].dataset.label;
                                },
                                label: function(context) {
                                    return `Score: ${context.parsed.y}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render user activity chart
        function renderUserActivityChart(data) {
            const canvas = document.getElementById('userActivityChart');
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const months = data.user_activity.map(item => item.month);
            const totalUsers = data.user_activity.map(item => item.total_users);
            const activeUsers = data.user_activity.map(item => item.active_users);
            
            canvas.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Total Users',
                        data: totalUsers,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Active Users',
                        data: activeUsers,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Users'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // Show user management
        async function showUserManagement() {
            document.getElementById('userManagementModal').style.display = 'block';
            await loadUsers();
        }
        
        // Show import users
        function showImportUsers() {
            document.getElementById('importUsersModal').style.display = 'block';
            // Clear previous results
            document.getElementById('adminExcelImportResult').innerHTML = '';
            document.getElementById('adminExcelFileInput').value = '';
        }
        
        // Import users from Excel
        async function importUsersFromExcel() {
            const fileInput = document.getElementById('adminExcelFileInput');
            const resultDiv = document.getElementById('adminExcelImportResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">Please select an Excel file</div>';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file type
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                resultDiv.innerHTML = '<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">Only Excel files (.xlsx, .xls) are supported</div>';
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading status
            resultDiv.innerHTML = '<div class="loading" style="padding: 10px; margin-top: 10px; background: #d1ecf1; color: #0c5460; border-radius: 5px;">Uploading and processing Excel file...</div>';
            
            try {
                const response = await fetch('/api/admin/import-users-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let resultHtml = `<div class="success" style="padding: 15px; margin-top: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
                        <h4 style="margin-bottom: 10px; margin-top: 0;">Import Complete!</h4>
                        <p><strong>New Users:</strong> ${result.imported_count}</p>
                        <p><strong>Updated Users:</strong> ${result.updated_count}</p>
                        <p><strong>Course Enrollments:</strong> ${result.enrolled_count}</p>
                        <p><strong>Skipped:</strong> ${result.skipped_count}</p>
                        <p><strong>Total Rows:</strong> ${result.total_rows}</p>
                    </div>`;
                    
                    if (result.errors && result.errors.length > 0) {
                        resultHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; color: #856404; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                            <strong>Errors (First 20):</strong>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                ${result.errors.map(err => `<li style="font-size: 12px;">${err}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    resultDiv.innerHTML = resultHtml;
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Refresh user list and statistics
                    loadUsers();
                    loadDashboardData();
                } else {
                    let errorMsg = result.error || 'Import failed';
                    if (result.required_columns) {
                        errorMsg += `<br>Required columns: ${result.required_columns.join(', ')}`;
                        if (result.found_columns) {
                            errorMsg += `<br>Found columns: ${result.found_columns.join(', ')}`;
                        }
                    }
                    resultDiv.innerHTML = `<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">${errorMsg}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">Network error: ${error.message}</div>`;
            }
        }
        
        // Load user list
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                }
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<div class="error">Failed to load users</div>';
            }
        }
        
        // Display user list
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (users.length === 0) {
                container.innerHTML = '<p>No users</p>';
                return;
            }
            
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.full_name}</td>
                                <td>${user.email}</td>
                                <td><span class="role-badge role-${user.role}">${getRoleName(user.role)}</span></td>
                                <td>${new Date(user.created_at).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editUser(${user.id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Show course management
        async function showCourseManagement() {
            document.getElementById('courseManagementModal').style.display = 'block';
            await loadCourses();
        }
        
        // Load course list
        async function loadCourses() {
            try {
                const response = await fetch('/api/admin/courses');
                if (response.ok) {
                    const courses = await response.json();
                    displayCoursesManagement(courses);
                }
            } catch (error) {
                document.getElementById('coursesManagementList').innerHTML = '<div class="error">Failed to load courses</div>';
            }
        }
        
        // Display course management list
        function displayCoursesManagement(courses) {
            const container = document.getElementById('coursesManagementList');
            if (courses.length === 0) {
                container.innerHTML = '<p>No courses</p>';
                return;
            }
            
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Teacher</th>
                            <th>Semester</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${courses.map(course => `
                            <tr>
                                <td>${course.course_code}</td>
                                <td>${course.course_name}</td>
                                <td>${course.teacher_name || 'Unknown'}</td>
                                <td>${course.semester} ${course.academic_year}</td>
                                <td><span style="color: ${course.is_active ? 'green' : 'red'}">${course.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editCourse(${course.id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteCourse(${course.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Show activity management
        async function showActivityManagement() {
            document.getElementById('activityManagementModal').style.display = 'block';
            await loadActivities();
        }
        
        // Load activity list
        async function loadActivities() {
            try {
                const response = await fetch('/api/admin/activities');
                if (response.ok) {
                    const activities = await response.json();
                    displayActivitiesManagement(activities);
                }
            } catch (error) {
                document.getElementById('activitiesManagementList').innerHTML = '<div class="error">Failed to load activities</div>';
            }
        }
        
        // Display activity management list
        function displayActivitiesManagement(activities) {
            const container = document.getElementById('activitiesManagementList');
            if (activities.length === 0) {
                container.innerHTML = '<p>No activities</p>';
                return;
            }
            
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Activity Title</th>
                            <th>Type</th>
                            <th>Course</th>
                            <th>Creator</th>
                            <th>Status</th>
                            <th>Responses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${activities.map(activity => `
                            <tr>
                                <td>${activity.title}</td>
                                <td>${getActivityTypeName(activity.activity_type)}</td>
                                <td>${activity.course_name || 'Unknown'}</td>
                                <td>${activity.creator_name || 'Unknown'}</td>
                                <td><span style="color: ${getStatusColor(activity.status)}">${getStatusName(activity.status)}</span></td>
                                <td>${activity.response_count}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="deleteActivity(${activity.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Show system logs
        async function showSystemLogs() {
            document.getElementById('systemLogsModal').style.display = 'block';
            await loadSystemLogs();
        }
        
        // Load system logs
        async function loadSystemLogs() {
            try {
                const response = await fetch('/api/admin/logs');
                if (response.ok) {
                    const data = await response.json();
                    displaySystemLogs(data.logs);
                }
            } catch (error) {
                document.getElementById('systemLogsList').innerHTML = '<div class="error">Failed to load logs</div>';
            }
        }
        
        // Display system logs
        function displaySystemLogs(logs) {
            const container = document.getElementById('systemLogsList');
            if (logs.length === 0) {
                container.innerHTML = '<p>No logs</p>';
                return;
            }
            
            const html = logs.map(log => `
                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: ${getLogLevelColor(log.level)}">${log.level}</span>
                        <span style="color: #666; font-size: 0.9em;">${new Date(log.timestamp).toLocaleString()}</span>
                    </div>
                    <p style="margin: 10px 0;">${log.message}</p>
                    <p style="color: #666; font-size: 0.9em;">User: ${log.user}</p>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Create backup
        async function createBackup() {
            try {
                const response = await fetch('/api/admin/backup', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage(`Backup created successfully! Backup ID: ${data.backup_id}`, 'success');
                } else {
                    showMessage('Failed to create backup', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Show system settings
        function showSystemSettings() {
            showMessage('System settings feature under development...', 'success');
        }
        
        // Show create user modal
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }
        
        // Bind create user form submit event
        function bindCreateUserFormEvent() {
            const createUserForm = document.getElementById('createUserForm');
            if (createUserForm) {
                // Remove old event listener (if exists)
                const newForm = createUserForm.cloneNode(true);
                createUserForm.parentNode.replaceChild(newForm, createUserForm);
                
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const data = {
                        username: document.getElementById('userUsername').value.trim(),
                        email: document.getElementById('userEmail').value.trim(),
                        full_name: document.getElementById('userFullName').value.trim(),
                        role: document.getElementById('userRole').value,
                        password: document.getElementById('userPassword').value,
                        department: document.getElementById('userDepartment').value.trim() || null
                    };
                    
                    // Validate required fields
                    if (!data.username || !data.email || !data.full_name || !data.role || !data.password) {
                        showMessage('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    if (data.role === 'student') {
                        const studentId = document.getElementById('userStudentId').value.trim();
                        if (!studentId) {
                            showMessage('Student role must provide student ID', 'error');
                            return;
                        }
                        data.student_id = studentId;
                    }
                    
                    try {
                        const response = await fetch('/api/admin/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            showMessage('User created successfully!', 'success');
                            closeModal('createUserModal');
                            document.getElementById('createUserForm').reset();
                            loadUsers();
                            loadDashboardData();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'Failed to create user', 'error');
                        }
                    } catch (error) {
                        showMessage('Network error: ' + error.message, 'error');
                    }
                });
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('User deleted successfully!', 'success');
                    loadUsers();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Delete course
        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/courses/${courseId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Course deleted successfully!', 'success');
                    loadCourses();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to delete course', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Delete activity
        async function deleteActivity(activityId) {
            if (!confirm('Are you sure you want to delete this activity?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/activities/${activityId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Activity deleted successfully!', 'success');
                    loadActivities();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to delete activity', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            // Remove existing message
            const existingMessage = document.querySelector('.success, .error');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '80px';
            messageDiv.style.right = '20px';
            messageDiv.style.padding = '15px 20px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.color = 'white';
            messageDiv.style.fontWeight = '500';
            messageDiv.style.zIndex = '2000';
            messageDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            messageDiv.style.animation = 'slideIn 0.3s ease';
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#28a745';
            } else {
                messageDiv.style.backgroundColor = '#dc3545';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // Utility functions
        function getRoleName(role) {
            const roles = {
                'teacher': 'Teacher',
                'student': 'Student',
                'admin': 'Admin'
            };
            return roles[role] || role;
        }
        
        function getActivityTypeName(type) {
            const types = {
                'poll': 'Poll',
                'quiz': 'Quiz',
                'word_cloud': 'Word Cloud',
                'short_answer': 'Short Answer',
                'mini_game': 'Mini Game'
            };
            return types[type] || type;
        }
        
        function getStatusName(status) {
            const statuses = {
                'draft': 'Draft',
                'active': 'Active',
                'completed': 'Completed',
                'archived': 'Archived'
            };
            return statuses[status] || status;
        }
        
        function getStatusColor(status) {
            const colors = {
                'draft': '#6c757d',
                'active': '#28a745',
                'completed': '#007bff',
                'archived': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }
        
        function getLogLevelColor(level) {
            const colors = {
                'INFO': '#007bff',
                'WARNING': '#ffc107',
                'ERROR': '#dc3545',
                'DEBUG': '#6c757d'
            };
            return colors[level] || '#6c757d';
        }
        
        // Edit user
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                if (response.ok) {
                    const user = await response.json();
                    // Fill form
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserUsername').value = user.username || '';
                    document.getElementById('editUserEmail').value = user.email || '';
                    document.getElementById('editUserFullName').value = user.full_name || '';
                    document.getElementById('editUserRole').value = user.role || '';
                    document.getElementById('editUserStudentId').value = user.student_id || '';
                    document.getElementById('editUserDepartment').value = user.department || '';
                    // Show modal
                    document.getElementById('editUserModal').style.display = 'block';
                    // Rebind event listener (ensure form can submit)
                    bindEditUserFormEvent();
                } else {
                    showMessage('Failed to load user information', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Bind edit user form submit event
        function bindEditUserFormEvent() {
            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                // Remove old event listener
                const newForm = editUserForm.cloneNode(true);
                editUserForm.parentNode.replaceChild(newForm, editUserForm);
                
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const userId = document.getElementById('editUserId').value;
                    if (!userId) {
                        showMessage('User ID does not exist', 'error');
                        return;
                    }
                    
                    const data = {
                        username: document.getElementById('editUserUsername').value,
                        email: document.getElementById('editUserEmail').value,
                        full_name: document.getElementById('editUserFullName').value,
                        role: document.getElementById('editUserRole').value,
                        student_id: document.getElementById('editUserStudentId').value || null,
                        department: document.getElementById('editUserDepartment').value || null
                    };
                    
                    try {
                        const response = await fetch(`/api/admin/users/${userId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            showMessage('User information updated successfully!', 'success');
                            closeModal('editUserModal');
                            loadUsers();
                            loadDashboardData();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'Failed to update user', 'error');
                        }
                    } catch (error) {
                        showMessage('Network error: ' + error.message, 'error');
                    }
                });
            }
        }
        
        // Edit course
        async function editCourse(courseId) {
            try {
                const response = await fetch(`/api/admin/courses/${courseId}`);
                if (response.ok) {
                    const course = await response.json();
                    // Fill form
                    document.getElementById('editCourseId').value = course.id;
                    document.getElementById('editCourseName').value = course.course_name || '';
                    document.getElementById('editCourseCode').value = course.course_code || '';
                    document.getElementById('editCourseDescription').value = course.description || '';
                    document.getElementById('editCourseActive').value = course.is_active ? 'true' : 'false';
                    // Show modal
                    document.getElementById('editCourseModal').style.display = 'block';
                    // Rebind event listener (ensure form can submit)
                    bindEditCourseFormEvent();
                } else {
                    showMessage('Failed to load course information', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }
        
        // Bind edit course form submit event
        function bindEditCourseFormEvent() {
            const editCourseForm = document.getElementById('editCourseForm');
            if (editCourseForm) {
                // Remove old event listener
                const newForm = editCourseForm.cloneNode(true);
                editCourseForm.parentNode.replaceChild(newForm, editCourseForm);
                
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const courseId = document.getElementById('editCourseId').value;
                    if (!courseId) {
                        showMessage('Course ID does not exist', 'error');
                        return;
                    }
                    
                    const data = {
                        course_name: document.getElementById('editCourseName').value,
                        course_code: document.getElementById('editCourseCode').value,
                        description: document.getElementById('editCourseDescription').value,
                        is_active: document.getElementById('editCourseActive').value === 'true'
                    };
                    
                    try {
                        const response = await fetch(`/api/admin/courses/${courseId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            showMessage('Course information updated successfully!', 'success');
                            closeModal('editCourseModal');
                            loadCourses();
                            loadDashboardData();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'Failed to update course', 'error');
                        }
                    } catch (error) {
                        showMessage('Network error: ' + error.message, 'error');
                    }
                });
            }
        }
        
    </script>
</body>
</html>
