<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Admin Dashboard - Smart Classroom Platform" data-zh="ç®¡ç†å‘˜ä»ªè¡¨æ¿ - æ™ºèƒ½è¯¾å ‚äº’åŠ¨å¹³å°">ç®¡ç†å‘˜ä»ªè¡¨æ¿ - æ™ºèƒ½è¯¾å ‚äº’åŠ¨å¹³å°</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="/static/js/i18n.js"></script>
    <style>
        /* é€šç”¨æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background: #f5f6fa;
            color: #222;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #082f49;
            color: #fff;
            padding: 15px 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        header h1::before {
            content: "âš™ï¸";
            font-size: 22px;
        }

        header .nav-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lang-switch {
            background: #fff;
            color: #082f49;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn {
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            cursor: pointer;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        /* å¡ç‰‡åŒºå¸ƒå±€ */
        .metrics {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            flex: 1;
            background: #083d5d;
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }

        .metric-card h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .metric-card p {
            font-size: 28px;
            font-weight: bold;
        }

        /* æ¨¡å—æ ‡é¢˜ */
        section h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #082f49;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* åŒºå—å¡ */
        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.05);
        }

        .card .loading {
            color: #999;
            text-align: center;
            padding: 10px 0;
        }

        button.primary {
            background-color: #083d5d;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        button.primary:hover {
            background-color: #0b4b70;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            main {
                padding: 20px;
            }

            .metrics {
                flex-direction: column;
            }
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .role-teacher {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .role-student {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .role-admin {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-placeholder {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1em;
        }
        
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .action-card:hover {
            transform: translateY(-2px);
        }
        
        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .action-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .action-description {
            color: #666;
            font-size: 0.9em;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .admin-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="platform-logo" style="display: flex; align-items: center;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 260 90" style="height:40px;">
                    <!-- èƒŒæ™¯å…­è¾¹å½¢è½®å»“ï¼ˆPolyUé£æ ¼ï¼‰ -->
                    <polygon points="30,45 50,15 90,15 110,45 90,75 50,75" fill="none" stroke="#ff6b6b" stroke-width="3"/>

                    <!-- æ‰“å¼€çš„ä¹¦æœ¬ï¼ˆæ•™è‚²ï¼‰ -->
                    <path d="M60 40 Q75 25 90 40 Q105 55 120 40 Q135 25 150 40" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" />

                    <!-- ä¹¦è„Š -->
                    <line x1="105" y1="40" x2="105" y2="70" stroke="#ffffff" stroke-width="3"/>

                    <!-- ç”µè·¯èŠ‚ç‚¹ï¼ˆç§‘æŠ€è¿æ¥çº¿ï¼‰ -->
                    <circle cx="75" cy="28" r="3" fill="#4facfe"/>
                    <circle cx="135" cy="28" r="3" fill="#4facfe"/>
                    <line x1="75" y1="28" x2="135" y2="28" stroke="#4facfe" stroke-width="2" stroke-dasharray="4 3"/>

                    <!-- ä¹¦ä¸Šå‘å…‰çµæ„Ÿç‚¹ -->
                    <circle cx="105" cy="18" r="4" fill="#ffd54f"/>

                    <!-- æ–‡æœ¬éƒ¨åˆ† -->
                    <text x="160" y="42" font-size="18" font-family="Inter, PingFang SC, sans-serif" font-weight="700" fill="#ffffff">PolyLearn</text>
                    <text x="160" y="65" font-size="12" font-family="Inter, sans-serif" fill="#b0bec5">Smart Learning</text>
                </svg>
            </div>
            <h1 data-en="Admin Dashboard" data-zh="ç®¡ç†å‘˜ä»ªè¡¨æ¿" style="margin: 0;">ç®¡ç†å‘˜ä»ªè¡¨æ¿</h1>
        </div>
        <div class="nav-actions">
            <button id="languageToggle" class="lang-switch" onclick="toggleLanguage()">
                ğŸŒ EN
            </button>
            <span id="userName" data-en="Loading..." data-zh="åŠ è½½ä¸­...">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="logout()" data-en="Logout" data-zh="ç™»å‡º">ç™»å‡º</button>
        </div>
    </header>
    
    <main>
        <!-- æ•°æ®æŒ‡æ ‡ -->
        <div class="metrics">
            <div class="metric-card">
                <h3 data-en="Total Users" data-zh="æ€»ç”¨æˆ·æ•°">æ€»ç”¨æˆ·æ•°</h3>
                <p id="totalUsers">0</p>
            </div>
            <div class="metric-card">
                <h3 data-en="Total Courses" data-zh="æ€»è¯¾ç¨‹æ•°">æ€»è¯¾ç¨‹æ•°</h3>
                <p id="totalCourses">0</p>
            </div>
            <div class="metric-card">
                <h3 data-en="Total Activities" data-zh="æ€»æ´»åŠ¨æ•°">æ€»æ´»åŠ¨æ•°</h3>
                <p id="totalActivities">0</p>
            </div>
            <div class="metric-card">
                <h3 data-en="Total Responses" data-zh="æ€»å“åº”æ•°">æ€»å“åº”æ•°</h3>
                <p id="totalResponses">0</p>
            </div>
            <div class="metric-card">
                <h3 data-en="Active Users" data-zh="æ´»è·ƒç”¨æˆ·">æ´»è·ƒç”¨æˆ·</h3>
                <p id="activeUsers">0</p>
            </div>
            <div class="metric-card">
                <h3 data-en="AI Activities" data-zh="AIç”Ÿæˆæ´»åŠ¨">AIç”Ÿæˆæ´»åŠ¨</h3>
                <p id="aiActivities">0</p>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç† -->
        <section class="card">
            <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="primary" onclick="showUserManagement()">ç®¡ç†ç”¨æˆ·</button>
                <button class="primary" onclick="showImportUsers()" style="background: #28a745;">æ‰¹é‡å¯¼å…¥ç”¨æˆ·</button>
            </div>
            <div id="usersList" class="loading">åŠ è½½ä¸­...</div>
        </section>

        <!-- è¯¾ç¨‹ç®¡ç† -->
        <section class="card">
            <h2>ğŸ“š è¯¾ç¨‹ç®¡ç†</h2>
            <button class="primary" onclick="showCourseManagement()">ç®¡ç†è¯¾ç¨‹</button>
            <div id="coursesManagementList" class="loading">åŠ è½½ä¸­...</div>
        </section>

        <!-- æ´»åŠ¨ç®¡ç† -->
        <section class="card">
            <h2>ğŸ¯ æ´»åŠ¨ç®¡ç†</h2>
            <button class="primary" onclick="showActivityManagement()">ç®¡ç†æ´»åŠ¨</button>
            <div id="activitiesManagementList" class="loading">åŠ è½½ä¸­...</div>
        </section>

        <!-- ç³»ç»Ÿæ¦‚è§ˆ -->
        <section class="card">
            <h2>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>
            <div id="systemOverview" class="loading">åŠ è½½ä¸­...</div>
        </section>
    </main>

    <footer>
        æ™ºèƒ½è¯¾å ‚äº’åŠ¨å¹³å° Â© 2025
    </footer>
    
    <!-- ç”¨æˆ·ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userManagementModal')">&times;</span>
            <h2>ç”¨æˆ·ç®¡ç†</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadUsers()">åˆ·æ–°ç”¨æˆ·</button>
                <button class="btn btn-success" onclick="showCreateUserModal()">åˆ›å»ºç”¨æˆ·</button>
            </div>
            <div id="usersList" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- æ‰¹é‡å¯¼å…¥ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="importUsersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('importUsersModal')">&times;</span>
            <h2>æ‰¹é‡å¯¼å…¥ç”¨æˆ·ï¼ˆExcelï¼‰</h2>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 5px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">Excelæ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h3>
                <p><strong>å¿…éœ€åˆ—ï¼š</strong></p>
                <ul>
                    <li><code>username</code> - ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰</li>
                    <li><code>full_name</code> - å§“å</li>
                    <li><code>email</code> - é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰</li>
                    <li><code>role</code> - è§’è‰²ï¼ˆstudent æˆ– teacherï¼‰</li>
                </ul>
                <p><strong>å¯é€‰åˆ—ï¼š</strong></p>
                <ul>
                    <li><code>department</code> - é™¢ç³»</li>
                    <li><code>student_id</code> - å­¦ç”ŸIDï¼ˆå½“roleä¸ºstudentæ—¶å¿…éœ€ï¼‰</li>
                    <li><code>course_code</code> - è¯¾ç¨‹ä»£ç ï¼ˆä»…å­¦ç”Ÿï¼Œç”¨äºè‡ªåŠ¨æ³¨å†Œè¯¾ç¨‹ï¼‰</li>
                </ul>
                <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>æ³¨æ„ï¼š</strong>æ‰€æœ‰æ–°åˆ›å»ºçš„ç”¨æˆ·é»˜è®¤å¯†ç ä¸º <code>123456</code>
                </p>
                <p style="margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 5px;">
                    <strong>é‚®ç®±æ ¼å¼è¦æ±‚ï¼š</strong>é‚®ç®±å¿…é¡»ä»¥ <code>@connect.polyu.hk</code> ç»“å°¾ï¼ˆä¾‹å¦‚ï¼š<code>24085316G@connect.polyu.hk</code>ï¼‰
                </p>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; border: 2px dashed #4facfe;">
                <input type="file" id="adminExcelFileInput" accept=".xlsx,.xls" style="margin-bottom: 15px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <button class="btn btn-success" onclick="importUsersFromExcel()" style="width: 100%; padding: 12px; font-size: 16px;">
                    ä¸Šä¼ å¹¶å¯¼å…¥ç”¨æˆ·
                </button>
                <div id="adminExcelImportResult" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createUserModal')">&times;</span>
            <h2>åˆ›å»ºç”¨æˆ·</h2>
            <form id="createUserForm">
                <div class="form-group">
                    <label for="userUsername">ç”¨æˆ·å:</label>
                    <input type="text" id="userUsername" placeholder="è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">é‚®ç®±:</label>
                    <input type="email" id="userEmail" placeholder="ä¾‹å¦‚: 24085316G@connect.polyu.hk" required>
                    <small style="color: #666; font-size: 12px;">é‚®ç®±å¿…é¡»ä»¥ @connect.polyu.hk ç»“å°¾</small>
                </div>
                <div class="form-group">
                    <label for="userFullName">å§“å:</label>
                    <input type="text" id="userFullName" placeholder="è¾“å…¥çœŸå®å§“å" required>
                </div>
                <div class="form-group">
                    <label for="userRole">è§’è‰²:</label>
                    <select id="userRole" required>
                        <option value="">é€‰æ‹©è§’è‰²</option>
                        <option value="teacher">æ•™å¸ˆ</option>
                        <option value="student">å­¦ç”Ÿ</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userPassword">å¯†ç :</label>
                    <input type="password" id="userPassword" placeholder="è¾“å…¥å¯†ç " required>
                </div>
                <div class="form-group">
                    <label for="userStudentId">å­¦ç”ŸID (ä»…å­¦ç”Ÿ):</label>
                    <input type="text" id="userStudentId" placeholder="è¾“å…¥å­¦ç”ŸID">
                </div>
                <div class="form-group">
                    <label for="userDepartment">é™¢ç³»:</label>
                    <input type="text" id="userDepartment" placeholder="è¾“å…¥é™¢ç³»">
                </div>
                <button type="submit" class="btn">åˆ›å»ºç”¨æˆ·</button>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            <h2>ç¼–è¾‘ç”¨æˆ·</h2>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserUsername">ç”¨æˆ·å:</label>
                    <input type="text" id="editUserUsername" placeholder="è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="editUserEmail">é‚®ç®±:</label>
                    <input type="email" id="editUserEmail" placeholder="ä¾‹å¦‚: 24085316G@connect.polyu.hk" required>
                    <small style="color: #666; font-size: 12px;">é‚®ç®±å¿…é¡»ä»¥ @connect.polyu.hk ç»“å°¾</small>
                </div>
                <div class="form-group">
                    <label for="editUserFullName">å§“å:</label>
                    <input type="text" id="editUserFullName" placeholder="è¾“å…¥çœŸå®å§“å" required>
                </div>
                <div class="form-group">
                    <label for="editUserRole">è§’è‰²:</label>
                    <select id="editUserRole" required>
                        <option value="">é€‰æ‹©è§’è‰²</option>
                        <option value="teacher">æ•™å¸ˆ</option>
                        <option value="student">å­¦ç”Ÿ</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserStudentId">å­¦ç”ŸID (ä»…å­¦ç”Ÿ):</label>
                    <input type="text" id="editUserStudentId" placeholder="è¾“å…¥å­¦ç”ŸID">
                </div>
                <div class="form-group">
                    <label for="editUserDepartment">é™¢ç³»:</label>
                    <input type="text" id="editUserDepartment" placeholder="è¾“å…¥é™¢ç³»">
                </div>
                <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘è¯¾ç¨‹æ¨¡æ€æ¡† -->
    <div id="editCourseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editCourseModal')">&times;</span>
            <h2>ç¼–è¾‘è¯¾ç¨‹</h2>
            <form id="editCourseForm">
                <input type="hidden" id="editCourseId">
                <div class="form-group">
                    <label for="editCourseName">è¯¾ç¨‹åç§°:</label>
                    <input type="text" id="editCourseName" placeholder="è¾“å…¥è¯¾ç¨‹åç§°" required>
                </div>
                <div class="form-group">
                    <label for="editCourseCode">è¯¾ç¨‹ä»£ç :</label>
                    <input type="text" id="editCourseCode" placeholder="è¾“å…¥è¯¾ç¨‹ä»£ç " required>
                </div>
                <div class="form-group">
                    <label for="editCourseDescription">è¯¾ç¨‹æè¿°:</label>
                    <textarea id="editCourseDescription" placeholder="è¾“å…¥è¯¾ç¨‹æè¿°" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editCourseActive">çŠ¶æ€:</label>
                    <select id="editCourseActive" required>
                        <option value="true">æ´»è·ƒ</option>
                        <option value="false">éæ´»è·ƒ</option>
                    </select>
                </div>
                <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
            </form>
        </div>
    </div>
    
    <!-- è¯¾ç¨‹ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="courseManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('courseManagementModal')">&times;</span>
            <h2>è¯¾ç¨‹ç®¡ç†</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadCourses()">åˆ·æ–°è¯¾ç¨‹</button>
            </div>
            <div id="coursesManagementList" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- æ´»åŠ¨ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="activityManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('activityManagementModal')">&times;</span>
            <h2>æ´»åŠ¨ç®¡ç†</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadActivities()">åˆ·æ–°æ´»åŠ¨</button>
            </div>
            <div id="activitiesManagementList" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- ç³»ç»Ÿæ—¥å¿—æ¨¡æ€æ¡† -->
    <div id="systemLogsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('systemLogsModal')">&times;</span>
            <h2>ç³»ç»Ÿæ—¥å¿—</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loadSystemLogs()">åˆ·æ–°æ—¥å¿—</button>
            </div>
            <div id="systemLogsList" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        let currentUser = null;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            await checkAuth();
            await loadDashboardData();
            // è‡ªåŠ¨åŠ è½½ç”¨æˆ·ã€è¯¾ç¨‹å’Œæ´»åŠ¨åˆ—è¡¨
            await loadUsers();
            await loadCourses();
            await loadActivities();
            // ç»‘å®šç¼–è¾‘è¡¨å•æäº¤äº‹ä»¶
            bindEditFormEvents();
            // ç»‘å®šåˆ›å»ºç”¨æˆ·è¡¨å•æäº¤äº‹ä»¶
            bindCreateUserFormEvent();
        };
        
        // ç»‘å®šç¼–è¾‘è¡¨å•æäº¤äº‹ä»¶ï¼ˆé¡µé¢åŠ è½½æ—¶ï¼‰
        function bindEditFormEvents() {
            // åˆå§‹åŒ–æ—¶ç»‘å®šä¸€æ¬¡ï¼Œä½†ä¸»è¦æ˜¯åœ¨æ‰“å¼€æ¨¡æ€æ¡†æ—¶é‡æ–°ç»‘å®š
            bindEditUserFormEvent();
            bindEditCourseFormEvent();
        }
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/profile');
                if (response.ok) {
                    currentUser = await response.json();
                    if (currentUser.role !== 'admin') {
                        window.location.href = '/login';
                        return;
                    }
                    document.getElementById('userName').textContent = currentUser.full_name;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/analytics/dashboard');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalUsers').textContent = data.stats.total_users;
                    document.getElementById('totalCourses').textContent = data.stats.total_courses;
                    document.getElementById('totalActivities').textContent = data.stats.total_activities;
                    document.getElementById('totalResponses').textContent = data.stats.total_responses;
                    document.getElementById('activeUsers').textContent = data.stats.active_users;
                    document.getElementById('aiActivities').textContent = data.stats.ai_activities;
                    
                    // æ˜¾ç¤ºç”¨æˆ·è§’è‰²åˆ†å¸ƒ
                    displayRoleChart(data.role_stats);
                    
                    // æ˜¾ç¤ºæœ€è¿‘æ³¨å†Œç”¨æˆ·
                    displayRecentUsers(data.recent_users);
                }
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·è§’è‰²åˆ†å¸ƒ
        function displayRoleChart(roleStats) {
            const container = document.getElementById('roleChart');
            if (!roleStats || roleStats.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ•°æ®</p>';
                return;
            }
            
            const html = roleStats.map(stat => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e1e5e9;">
                    <span>${getRoleName(stat.role)}</span>
                    <span style="font-weight: bold; color: #4facfe;">${stat.count}</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºæœ€è¿‘æ³¨å†Œç”¨æˆ·
        function displayRecentUsers(users) {
            const container = document.getElementById('recentUsers');
            if (!users || users.length === 0) {
                container.innerHTML = '<p>æš‚æ— ç”¨æˆ·</p>';
                return;
            }
            
            const html = users.map(user => `
                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 10px;">
                    <h4>${user.full_name} (@${user.username})</h4>
                    <p>è§’è‰²: <span class="role-badge role-${user.role}">${getRoleName(user.role)}</span></p>
                    <p>é‚®ç®±: ${user.email}</p>
                    <p>æ³¨å†Œæ—¶é—´: ${new Date(user.created_at).toLocaleString()}</p>
                    <button class="btn btn-danger" onclick="deleteUser(${user.id})">åˆ é™¤ç”¨æˆ·</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ç®¡ç†
        async function showUserManagement() {
            document.getElementById('userManagementModal').style.display = 'block';
            await loadUsers();
        }
        
        // æ˜¾ç¤ºæ‰¹é‡å¯¼å…¥ç”¨æˆ·
        function showImportUsers() {
            document.getElementById('importUsersModal').style.display = 'block';
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('adminExcelImportResult').innerHTML = '';
            document.getElementById('adminExcelFileInput').value = '';
        }
        
        // ä»Excelå¯¼å…¥ç”¨æˆ·
        async function importUsersFromExcel() {
            const fileInput = document.getElementById('adminExcelFileInput');
            const resultDiv = document.getElementById('adminExcelImportResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">è¯·é€‰æ‹©Excelæ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                resultDiv.innerHTML = '<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">åªæ”¯æŒExcelæ–‡ä»¶(.xlsx, .xls)</div>';
                return;
            }
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultDiv.innerHTML = '<div class="loading" style="padding: 10px; margin-top: 10px; background: #d1ecf1; color: #0c5460; border-radius: 5px;">æ­£åœ¨ä¸Šä¼ å¹¶å¤„ç†Excelæ–‡ä»¶...</div>';
            
            try {
                const response = await fetch('/api/admin/import-users-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let resultHtml = `<div class="success" style="padding: 15px; margin-top: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
                        <h4 style="margin-bottom: 10px; margin-top: 0;">å¯¼å…¥å®Œæˆï¼</h4>
                        <p><strong>æ–°å¢ç”¨æˆ·:</strong> ${result.imported_count} å</p>
                        <p><strong>æ›´æ–°ç”¨æˆ·:</strong> ${result.updated_count} å</p>
                        <p><strong>æ³¨å†Œè¯¾ç¨‹:</strong> ${result.enrolled_count} æ¬¡</p>
                        <p><strong>è·³è¿‡:</strong> ${result.skipped_count} å</p>
                        <p><strong>æ€»è¡Œæ•°:</strong> ${result.total_rows} è¡Œ</p>
                    </div>`;
                    
                    if (result.errors && result.errors.length > 0) {
                        resultHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; color: #856404; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                            <strong>é”™è¯¯ä¿¡æ¯ï¼ˆå‰20æ¡ï¼‰:</strong>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                ${result.errors.map(err => `<li style="font-size: 12px;">${err}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    resultDiv.innerHTML = resultHtml;
                    
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    fileInput.value = '';
                    
                    // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨å’Œç»Ÿè®¡æ•°æ®
                    loadUsers();
                    loadDashboardData();
                } else {
                    let errorMsg = result.error || 'å¯¼å…¥å¤±è´¥';
                    if (result.required_columns) {
                        errorMsg += `<br>å¿…éœ€åˆ—: ${result.required_columns.join(', ')}`;
                        if (result.found_columns) {
                            errorMsg += `<br>æ‰¾åˆ°çš„åˆ—: ${result.found_columns.join(', ')}`;
                        }
                    }
                    resultDiv.innerHTML = `<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">${errorMsg}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error" style="padding: 10px; margin-top: 10px; background: #f8d7da; color: #721c24; border-radius: 5px;">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                }
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<div class="error">åŠ è½½ç”¨æˆ·å¤±è´¥</div>';
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (users.length === 0) {
                container.innerHTML = '<p>æš‚æ— ç”¨æˆ·</p>';
                return;
            }
            
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th>å§“å</th>
                            <th>é‚®ç®±</th>
                            <th>è§’è‰²</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.full_name}</td>
                                <td>${user.email}</td>
                                <td><span class="role-badge role-${user.role}">${getRoleName(user.role)}</span></td>
                                <td>${new Date(user.created_at).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="deleteUser(${user.id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºè¯¾ç¨‹ç®¡ç†
        async function showCourseManagement() {
            document.getElementById('courseManagementModal').style.display = 'block';
            await loadCourses();
        }
        
        // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
        async function loadCourses() {
            try {
                const response = await fetch('/api/admin/courses');
                if (response.ok) {
                    const courses = await response.json();
                    displayCoursesManagement(courses);
                }
            } catch (error) {
                document.getElementById('coursesManagementList').innerHTML = '<div class="error">åŠ è½½è¯¾ç¨‹å¤±è´¥</div>';
            }
        }
        
        // æ˜¾ç¤ºè¯¾ç¨‹ç®¡ç†åˆ—è¡¨
        function displayCoursesManagement(courses) {
            const container = document.getElementById('coursesManagementList');
            if (courses.length === 0) {
                container.innerHTML = '<p>æš‚æ— è¯¾ç¨‹</p>';
                return;
            }
            
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>è¯¾ç¨‹ä»£ç </th>
                            <th>è¯¾ç¨‹åç§°</th>
                            <th>æ•™å¸ˆ</th>
                            <th>å­¦æœŸ</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${courses.map(course => `
                            <tr>
                                <td>${course.course_code}</td>
                                <td>${course.course_name}</td>
                                <td>${course.teacher_name || 'æœªçŸ¥'}</td>
                                <td>${course.semester} ${course.academic_year}</td>
                                <td><span style="color: ${course.is_active ? 'green' : 'red'}">${course.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}</span></td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editCourse(${course.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="deleteCourse(${course.id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºæ´»åŠ¨ç®¡ç†
        async function showActivityManagement() {
            document.getElementById('activityManagementModal').style.display = 'block';
            await loadActivities();
        }
        
        // åŠ è½½æ´»åŠ¨åˆ—è¡¨
        async function loadActivities() {
            try {
                const response = await fetch('/api/admin/activities');
                if (response.ok) {
                    const activities = await response.json();
                    displayActivitiesManagement(activities);
                }
            } catch (error) {
                document.getElementById('activitiesManagementList').innerHTML = '<div class="error">åŠ è½½æ´»åŠ¨å¤±è´¥</div>';
            }
        }
        
        // æ˜¾ç¤ºæ´»åŠ¨ç®¡ç†åˆ—è¡¨
        function displayActivitiesManagement(activities) {
            const container = document.getElementById('activitiesManagementList');
            if (activities.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ´»åŠ¨</p>';
                return;
            }
            
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ´»åŠ¨æ ‡é¢˜</th>
                            <th>ç±»å‹</th>
                            <th>è¯¾ç¨‹</th>
                            <th>åˆ›å»ºè€…</th>
                            <th>çŠ¶æ€</th>
                            <th>å“åº”æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${activities.map(activity => `
                            <tr>
                                <td>${activity.title}</td>
                                <td>${getActivityTypeName(activity.activity_type)}</td>
                                <td>${activity.course_name || 'æœªçŸ¥'}</td>
                                <td>${activity.creator_name || 'æœªçŸ¥'}</td>
                                <td><span style="color: ${getStatusColor(activity.status)}">${getStatusName(activity.status)}</span></td>
                                <td>${activity.response_count}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="deleteActivity(${activity.id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºç³»ç»Ÿæ—¥å¿—
        async function showSystemLogs() {
            document.getElementById('systemLogsModal').style.display = 'block';
            await loadSystemLogs();
        }
        
        // åŠ è½½ç³»ç»Ÿæ—¥å¿—
        async function loadSystemLogs() {
            try {
                const response = await fetch('/api/admin/logs');
                if (response.ok) {
                    const data = await response.json();
                    displaySystemLogs(data.logs);
                }
            } catch (error) {
                document.getElementById('systemLogsList').innerHTML = '<div class="error">åŠ è½½æ—¥å¿—å¤±è´¥</div>';
            }
        }
        
        // æ˜¾ç¤ºç³»ç»Ÿæ—¥å¿—
        function displaySystemLogs(logs) {
            const container = document.getElementById('systemLogsList');
            if (logs.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ—¥å¿—</p>';
                return;
            }
            
            const html = logs.map(log => `
                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: ${getLogLevelColor(log.level)}">${log.level}</span>
                        <span style="color: #666; font-size: 0.9em;">${new Date(log.timestamp).toLocaleString()}</span>
                    </div>
                    <p style="margin: 10px 0;">${log.message}</p>
                    <p style="color: #666; font-size: 0.9em;">ç”¨æˆ·: ${log.user}</p>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // åˆ›å»ºå¤‡ä»½
        async function createBackup() {
            try {
                const response = await fetch('/api/admin/backup', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage(`å¤‡ä»½åˆ›å»ºæˆåŠŸï¼å¤‡ä»½ID: ${data.backup_id}`, 'success');
                } else {
                    showMessage('åˆ›å»ºå¤‡ä»½å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // æ˜¾ç¤ºç³»ç»Ÿè®¾ç½®
        function showSystemSettings() {
            showMessage('ç³»ç»Ÿè®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'success');
        }
        
        // æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }
        
        // ç»‘å®šåˆ›å»ºç”¨æˆ·è¡¨å•æäº¤äº‹ä»¶
        function bindCreateUserFormEvent() {
            const createUserForm = document.getElementById('createUserForm');
            if (createUserForm) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const newForm = createUserForm.cloneNode(true);
                createUserForm.parentNode.replaceChild(newForm, createUserForm);
                
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const data = {
                        username: document.getElementById('userUsername').value.trim(),
                        email: document.getElementById('userEmail').value.trim(),
                        full_name: document.getElementById('userFullName').value.trim(),
                        role: document.getElementById('userRole').value,
                        password: document.getElementById('userPassword').value,
                        department: document.getElementById('userDepartment').value.trim() || null
                    };
                    
                    // éªŒè¯å¿…éœ€å­—æ®µ
                    if (!data.username || !data.email || !data.full_name || !data.role || !data.password) {
                        showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
                        return;
                    }
                    
                    if (data.role === 'student') {
                        const studentId = document.getElementById('userStudentId').value.trim();
                        if (!studentId) {
                            showMessage('å­¦ç”Ÿè§’è‰²å¿…é¡»æä¾›å­¦ç”ŸID', 'error');
                            return;
                        }
                        data.student_id = studentId;
                    }
                    
                    try {
                        const response = await fetch('/api/admin/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            showMessage('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼', 'success');
                            closeModal('createUserModal');
                            document.getElementById('createUserForm').reset();
                            loadUsers();
                            loadDashboardData();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'åˆ›å»ºç”¨æˆ·å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    }
                });
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼', 'success');
                    loadUsers();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'åˆ é™¤ç”¨æˆ·å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // åˆ é™¤è¯¾ç¨‹
        async function deleteCourse(courseId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯¾ç¨‹å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/courses/${courseId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('è¯¾ç¨‹åˆ é™¤æˆåŠŸï¼', 'success');
                    loadCourses();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'åˆ é™¤è¯¾ç¨‹å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // åˆ é™¤æ´»åŠ¨
        async function deleteActivity(activityId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/activities/${activityId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('æ´»åŠ¨åˆ é™¤æˆåŠŸï¼', 'success');
                    loadActivities();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'åˆ é™¤æ´»åŠ¨å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
            const existingMessage = document.querySelector('.success, .error');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '80px';
            messageDiv.style.right = '20px';
            messageDiv.style.padding = '15px 20px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.color = 'white';
            messageDiv.style.fontWeight = '500';
            messageDiv.style.zIndex = '2000';
            messageDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            messageDiv.style.animation = 'slideIn 0.3s ease';
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#28a745';
            } else {
                messageDiv.style.backgroundColor = '#dc3545';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // ç™»å‡º
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }
        
        // å·¥å…·å‡½æ•°
        function getRoleName(role) {
            const roles = {
                'teacher': 'æ•™å¸ˆ',
                'student': 'å­¦ç”Ÿ',
                'admin': 'ç®¡ç†å‘˜'
            };
            return roles[role] || role;
        }
        
        function getActivityTypeName(type) {
            const types = {
                'poll': 'æŠ•ç¥¨æ´»åŠ¨',
                'quiz': 'æµ‹éªŒæ´»åŠ¨',
                'word_cloud': 'è¯äº‘æ´»åŠ¨',
                'short_answer': 'ç®€ç­”é¢˜',
                'mini_game': 'è¿·ä½ æ¸¸æˆ'
            };
            return types[type] || type;
        }
        
        function getStatusName(status) {
            const statuses = {
                'draft': 'è‰ç¨¿',
                'active': 'è¿›è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'archived': 'å·²å½’æ¡£'
            };
            return statuses[status] || status;
        }
        
        function getStatusColor(status) {
            const colors = {
                'draft': '#6c757d',
                'active': '#28a745',
                'completed': '#007bff',
                'archived': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }
        
        function getLogLevelColor(level) {
            const colors = {
                'INFO': '#007bff',
                'WARNING': '#ffc107',
                'ERROR': '#dc3545',
                'DEBUG': '#6c757d'
            };
            return colors[level] || '#6c757d';
        }
        
        // ç¼–è¾‘ç”¨æˆ·
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                if (response.ok) {
                    const user = await response.json();
                    // å¡«å……è¡¨å•
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserUsername').value = user.username || '';
                    document.getElementById('editUserEmail').value = user.email || '';
                    document.getElementById('editUserFullName').value = user.full_name || '';
                    document.getElementById('editUserRole').value = user.role || '';
                    document.getElementById('editUserStudentId').value = user.student_id || '';
                    document.getElementById('editUserDepartment').value = user.department || '';
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('editUserModal').style.display = 'block';
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆç¡®ä¿è¡¨å•å¯ä»¥æäº¤ï¼‰
                    bindEditUserFormEvent();
                } else {
                    showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // ç»‘å®šç¼–è¾‘ç”¨æˆ·è¡¨å•æäº¤äº‹ä»¶
        function bindEditUserFormEvent() {
            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                const newForm = editUserForm.cloneNode(true);
                editUserForm.parentNode.replaceChild(newForm, editUserForm);
                
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const userId = document.getElementById('editUserId').value;
                    if (!userId) {
                        showMessage('ç”¨æˆ·IDä¸å­˜åœ¨', 'error');
                        return;
                    }
                    
                    const data = {
                        username: document.getElementById('editUserUsername').value,
                        email: document.getElementById('editUserEmail').value,
                        full_name: document.getElementById('editUserFullName').value,
                        role: document.getElementById('editUserRole').value,
                        student_id: document.getElementById('editUserStudentId').value || null,
                        department: document.getElementById('editUserDepartment').value || null
                    };
                    
                    try {
                        const response = await fetch(`/api/admin/users/${userId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            showMessage('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
                            closeModal('editUserModal');
                            loadUsers();
                            loadDashboardData();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'æ›´æ–°ç”¨æˆ·å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    }
                });
            }
        }
        
        // ç¼–è¾‘è¯¾ç¨‹
        async function editCourse(courseId) {
            try {
                const response = await fetch(`/api/admin/courses/${courseId}`);
                if (response.ok) {
                    const course = await response.json();
                    // å¡«å……è¡¨å•
                    document.getElementById('editCourseId').value = course.id;
                    document.getElementById('editCourseName').value = course.course_name || '';
                    document.getElementById('editCourseCode').value = course.course_code || '';
                    document.getElementById('editCourseDescription').value = course.description || '';
                    document.getElementById('editCourseActive').value = course.is_active ? 'true' : 'false';
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('editCourseModal').style.display = 'block';
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆç¡®ä¿è¡¨å•å¯ä»¥æäº¤ï¼‰
                    bindEditCourseFormEvent();
                } else {
                    showMessage('åŠ è½½è¯¾ç¨‹ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // ç»‘å®šç¼–è¾‘è¯¾ç¨‹è¡¨å•æäº¤äº‹ä»¶
        function bindEditCourseFormEvent() {
            const editCourseForm = document.getElementById('editCourseForm');
            if (editCourseForm) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                const newForm = editCourseForm.cloneNode(true);
                editCourseForm.parentNode.replaceChild(newForm, editCourseForm);
                
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const courseId = document.getElementById('editCourseId').value;
                    if (!courseId) {
                        showMessage('è¯¾ç¨‹IDä¸å­˜åœ¨', 'error');
                        return;
                    }
                    
                    const data = {
                        course_name: document.getElementById('editCourseName').value,
                        course_code: document.getElementById('editCourseCode').value,
                        description: document.getElementById('editCourseDescription').value,
                        is_active: document.getElementById('editCourseActive').value === 'true'
                    };
                    
                    try {
                        const response = await fetch(`/api/admin/courses/${courseId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            showMessage('è¯¾ç¨‹ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
                            closeModal('editCourseModal');
                            loadCourses();
                            loadDashboardData();
                        } else {
                            const error = await response.json();
                            showMessage(error.error || 'æ›´æ–°è¯¾ç¨‹å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    }
                });
            }
        }
        
    </script>
</body>
</html>
